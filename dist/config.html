<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>设置 - FreeChat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="header">
        <button id="backBtn" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1>设置</h1>
    </header>

    <main class="config-container">
        <div class="config-item">
            <label for="customModelSelect" class="config-label">选择模型</label>
            <!-- 保留原生 select 作为数据源并隐藏，以保持与现有保存/读取逻辑兼容（value 会由自定义组件同步） -->
            <select id="modelSelect" class="config-input" style="display:none;">
                <option value="">请选择模型</option>
                <option value="agentica-org/deepcoder-14b-preview:free">agentica-org/deepcoder-14b-preview:free</option>
                <option value="alibaba/tongyi-deepresearch-30b-a3b:free">alibaba/tongyi-deepresearch-30b-a3b:free</option>
                <option value="arliai/qwq-32b-arliai-rpr-v1:free">arliai/qwq-32b-arliai-rpr-v1:free</option>
                <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">cognitivecomputations/dolphin-mistral-24b-venice-edition:free</option>
                <option value="deepseek/deepseek-chat-v3-0324:free">deepseek/deepseek-chat-v3-0324:free</option>
                <option value="deepseek/deepseek-chat-v3.1:free">deepseek/deepseek-chat-v3.1:free</option>
                <option value="deepseek/deepseek-r1:free">deepseek/deepseek-r1:free</option>
                <option value="deepseek/deepseek-r1-0528:free">deepseek/deepseek-r1-0528:free</option>
                <option value="deepseek/deepseek-r1-0528-qwen3-8b:free">deepseek/deepseek-r1-0528-qwen3-8b:free</option>
                <option value="deepseek/deepseek-r1-distill-llama-70b:free">deepseek/deepseek-r1-distill-llama-70b:free</option>
                <option value="google/gemini-2.0-flash-exp:free">google/gemini-2.0-flash-exp:free</option>
                <option value="google/gemma-3-12b-it:free">google/gemma-3-12b-it:free</option>
                <option value="google/gemma-3-27b-it:free">google/gemma-3-27b-it:free</option>
                <option value="google/gemma-3-4b-it:free">google/gemma-3-4b-it:free</option>
                <option value="google/gemma-3n-e2b-it:free">google/gemma-3n-e2b-it:free</option>
                <option value="google/gemma-3n-e4b-it:free">google/gemma-3n-e4b-it:free</option>
                <option value="meituan/longcat-flash-chat:free">meituan/longcat-flash-chat:free</option>
                <option value="meta-llama/llama-3.2-3b-instruct:free">meta-llama/llama-3.2-3b-instruct:free</option>
                <option value="meta-llama/llama-3.3-8b-instruct:free">meta-llama/llama-3.3-8b-instruct:free</option>
                <option value="meta-llama/llama-3.3-70b-instruct:free">meta-llama/llama-3.3-70b-instruct:free</option>
                <option value="meta-llama/llama-4-maverick:free">meta-llama/llama-4-maverick:free</option>
                <option value="meta-llama/llama-4-scout:free">meta-llama/llama-4-scout:free</option>
                <option value="microsoft/mai-ds-r1:free">microsoft/mai-ds-r1:free</option>
                <option value="mistralai/mistral-7b-instruct:free">mistralai/mistral-7b-instruct:free</option>
                <option value="mistralai/mistral-nemo:free">mistralai/mistral-nemo:free</option>
                <option value="mistralai/mistral-small-24b-instruct-2501:free">mistralai/mistral-small-24b-instruct-2501:free</option>
                <option value="mistralai/mistral-small-3.1-24b-instruct:free">mistralai/mistral-small-3.1-24b-instruct:free</option>
                <option value="mistralai/mistral-small-3.2-24b-instruct:free">mistralai/mistral-small-3.2-24b-instruct:free</option>
                <option value="moonshotai/kimi-k2:free">moonshotai/kimi-k2:free</option>
                <option value="minimax/minimax-m2:free">minimax/minimax-m2:free</option>
                <option value="nvidia/nemotron-nano-12b-v2-vl:free">nvidia/nemotron-nano-12b-v2-vl:free</option>
                <option value="nvidia/nemotron-nano-9b-v2:free">nvidia/nemotron-nano-9b-v2:free</option>
                <option value="nousresearch/hermes-3-llama-3.1-405b:free">nousresearch/hermes-3-llama-3.1-405b:free</option>
                <option value="openai/gpt-oss-20b:free">openai/gpt-oss-20b:free</option>
                <option value="openrouter/polaris-alpha">openrouter/polaris-alpha</option>
                <option value="qwen/qwen-2.5-72b-instruct:free">qwen/qwen-2.5-72b-instruct:free</option>
                <option value="qwen/qwen-2.5-coder-32b-instruct:free">qwen/qwen-2.5-coder-32b-instruct:free</option>
                <option value="qwen/qwen2.5-vl-32b-instruct:free">qwen/qwen2.5-vl-32b-instruct:free</option>
                <option value="qwen/qwen3-14b:free">qwen/qwen3-14b:free</option>
                <option value="qwen/qwen3-4b:free">qwen/qwen3-4b:free</option>
                <option value="qwen/qwen3-30b-a3b:free">qwen/qwen3-30b-a3b:free</option>
                <option value="qwen/qwen3-235b-a22b:free">qwen/qwen3-235b-a22b:free</option>
                <option value="qwen/qwen3-coder:free">qwen/qwen3-coder:free</option>
                <option value="tngtech/deepseek-r1t-chimera:free">tngtech/deepseek-r1t-chimera:free</option>
                <option value="tngtech/deepseek-r1t2-chimera:free">tngtech/deepseek-r1t2-chimera:free</option>
                <option value="z-ai/glm-4.5-air:free">z-ai/glm-4.5-air:free</option>
            </select>
            <!-- 自定义下拉组件：在移动端保证单行显示、截断与搜索功能 -->
            <div class="custom-select" id="customModelSelect" data-value="">
              <button class="custom-select__trigger" aria-haspopup="listbox" aria-expanded="false" type="button">
                <span class="custom-select__value">请选择模型</span>
                <i class="fas fa-caret-down"></i>
              </button>
              <div class="custom-select__panel" role="listbox" tabindex="-1" aria-hidden="true">
                <input class="custom-select__search" placeholder="搜索模型" aria-label="搜索模型">
                <ul class="custom-select__options"></ul>
              </div>
            </div>
        </div>
        <!-- 联网搜索设置（从主页面迁移至设置页） -->
        <div class="config-item">
            <label for="webEngineSelectCfg" class="config-label">联网搜索引擎</label>
            <select id="webEngineSelectCfg" class="config-input">
                <option value="auto">auto（默认）</option>
                <option value="native">native</option>
                <option value="exa">exa</option>
            </select>
        </div>
        <div class="config-item">
            <label for="webMaxResultsInputCfg" class="config-label">最大结果数</label>
            <input type="number" id="webMaxResultsInputCfg" class="config-input" min="1" max="10" step="1" placeholder="1 - 10（默认 5）" />
        </div>
        <div class="config-item">
            <label for="webContextSizeSelectCfg" class="config-label">搜索上下文</label>
            <select id="webContextSizeSelectCfg" class="config-input">
                <option value="">- 不指定 -</option>
                <option value="low">low</option>
                <option value="medium">medium</option>
                <option value="high">high</option>
            </select>
        </div>
        <div class="config-item">
            <label for="webSearchPromptInputCfg" class="config-label">Search Prompt（可选）</label>
            <textarea id="webSearchPromptInputCfg" class="config-input" rows="3" placeholder="留空以使用默认提示"></textarea>
        </div>
        <button id="saveConfigBtn" class="save-btn">保存设置</button>
        <div id="saveMessage" class="save-message"></div>
    </main>

    <script>
        /**
         * 文件名：config.html
         * 功能描述：FreeChat 设置页面，提供模型选择和配置保存功能
         */
        // 确保路径正确的返回按钮
        document.getElementById('backBtn').addEventListener('click', function() {
            window.location.assign('index.html');
        });

        /**
         * 构建自定义下拉组件：从隐藏的原生 select 读取选项并在页面内渲染可搜索的列表
         * selectEl: 原生 <select> 元素（可为 null，若为 null 则不读取）
         */
        function buildCustomModelSelect(selectEl) {
            const container = document.getElementById('customModelSelect');
            if (!container) return;
            const trigger = container.querySelector('.custom-select__trigger');
            const valueEl = container.querySelector('.custom-select__value');
            const panel = container.querySelector('.custom-select__panel');
            const searchInput = container.querySelector('.custom-select__search');
            const optionsListEl = container.querySelector('.custom-select__options');

            // 从原生 select 提取选项数据
            const options = [];
            if (selectEl) {
                for (const opt of Array.from(selectEl.options)) {
                    if (!opt.value) continue;
                    options.push({ value: opt.value, label: opt.text });
                }
            }

            function renderList(filter = '') {
                const q = String(filter || '').trim().toLowerCase();
                optionsListEl.innerHTML = options
                    .filter(o => o.label.toLowerCase().includes(q) || o.value.toLowerCase().includes(q))
                    .map(o => `<li role="option" data-value="${o.value}" title="${o.label}">${o.label}</li>`).join('');
            }

            function openPanel() {
                panel.setAttribute('aria-hidden', 'false');
                trigger.setAttribute('aria-expanded', 'true');
                searchInput.focus();
            }
            function closePanel() {
                panel.setAttribute('aria-hidden', 'true');
                trigger.setAttribute('aria-expanded', 'false');
            }

            // 初始渲染
            renderList();

            // 事件：触发器切换
            trigger.addEventListener('click', (e) => {
                const expanded = trigger.getAttribute('aria-expanded') === 'true';
                if (expanded) closePanel(); else openPanel();
            });

            // 点击选项
            optionsListEl.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (!li) return;
                const v = li.dataset.value;
                const label = li.textContent;
                valueEl.textContent = label;
                // 同步到原生 select（隐藏）
                if (selectEl) selectEl.value = v;
                container.dataset.value = v;
                closePanel();
            });

            // 搜索输入
            searchInput.addEventListener('input', (e) => {
                renderList(e.target.value);
            });

            // 点击面板外部时关闭
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    closePanel();
                }
            });

            // 如果 localStorage 中已有选中模型，设置显示
            const saved = localStorage.getItem('chatModel');
            if (saved) {
                const found = options.find(o => o.value === saved);
                if (found) {
                    valueEl.textContent = found.label;
                    if (selectEl) selectEl.value = saved;
                    container.dataset.value = saved;
                }
            }
        }

        // 页面加载时获取保存的模型名称与联网搜索设置
        document.addEventListener('DOMContentLoaded', () => {
            const savedModel = localStorage.getItem('chatModel');
            if (savedModel) {
                document.getElementById('modelSelect').value = savedModel;
            }
            // 构建自定义下拉（从隐藏的原生 select 读取数据并渲染）
            buildCustomModelSelect(document.getElementById('modelSelect'));

            // 读取并初始化：联网搜索设置（保持与主页面相同键名与默认值）
            try {
                const read = (k, d) => {
                    const v = localStorage.getItem(k);
                    return (v === null || v === undefined) ? d : v;
                };

                const engineEl = document.getElementById('webEngineSelectCfg');
                const maxEl = document.getElementById('webMaxResultsInputCfg');
                const ctxEl = document.getElementById('webContextSizeSelectCfg');
                const promptEl = document.getElementById('webSearchPromptInputCfg');

                const engine = read('freechat.web.engine', 'auto');
                engineEl.value = (engine === 'native' || engine === 'exa') ? engine : 'auto';
                const maxResults = Math.max(1, Math.min(10, Number(read('freechat.web.maxResults', '5')) || 5));
                maxEl.value = String(maxResults);
                const ctx = read('freechat.web.contextSize', '');
                ctxEl.value = (ctx === 'low' || ctx === 'medium' || ctx === 'high') ? ctx : '';
                promptEl.value = read('freechat.web.searchPrompt', '');
            } catch (e) {
                console.error('初始化 联网搜索设置 失败：', e);
            }

            // 保存按钮事件
            document.getElementById('saveConfigBtn').addEventListener('click', () => {
                try {
                    // 保存模型
                    const modelName = document.getElementById('modelSelect').value;
                    if (modelName) {
                        localStorage.setItem('chatModel', modelName);
                    }

                    // 保存：联网搜索设置（空值移除，数值范围保护）
                    const engineEl = document.getElementById('webEngineSelectCfg');
                    const maxEl = document.getElementById('webMaxResultsInputCfg');
                    const ctxEl = document.getElementById('webContextSizeSelectCfg');
                    const promptEl = document.getElementById('webSearchPromptInputCfg');

                    const write = (k, v) => {
                        if (v === '' || v === null || v === undefined) localStorage.removeItem(k);
                        else localStorage.setItem(k, String(v));
                    };

                    // 引擎：写入 auto/native/exa（保持与主页面一致）
                    const engine = engineEl.value === 'native' || engineEl.value === 'exa' ? engineEl.value : 'auto';
                    write('freechat.web.engine', engine);

                    // 最大结果数：范围 1..10
                    const maxVal = Math.max(1, Math.min(10, Number(maxEl.value) || 5));
                    write('freechat.web.maxResults', String(maxVal));

                    // 上下文强度：允许为空（为空则移除键）
                    const ctx = (ctxEl.value === 'low' || ctxEl.value === 'medium' || ctxEl.value === 'high') ? ctxEl.value : '';
                    write('freechat.web.contextSize', ctx);

                    // 自定义搜索提示：允许为空（为空则移除键）
                    const searchPrompt = (promptEl.value || '').trim();
                    write('freechat.web.searchPrompt', searchPrompt);

                    const saveMessage = document.getElementById('saveMessage');
                    saveMessage.textContent = '保存成功！';
                    saveMessage.classList.add('success');

                    // 2秒后隐藏提示消息
                    setTimeout(() => {
                        saveMessage.textContent = '';
                        saveMessage.classList.remove('success');
                    }, 2000);
                } catch (e) {
                    console.error('保存设置失败：', e);
                }
            });
        });
    </script>
</body>
</html>