<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhoneChat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="prompts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        .input-container { position: relative; }
        .stop-btn-floating {
            position: absolute;
            right: 86px; 
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #e74c3c;
            color: #fff;
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 999;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            padding: 0;
        }
        .stop-btn-floating:active { transform: translateY(-50%) scale(0.96); }
        .stop-btn-floating .fa-stop { font-size: 14px; }
        .stop-btn-floating { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    </style>
</head>
<body>
    <header class="header">
        <button id="conversationsBtn" class="conversations-btn">
            <i class="fas fa-history"></i>
        </button>
        <h1>PhoneChat</h1>
        <button id="settingsBtn" class="settings-btn">
            <i class="fas fa-cog"></i>
        </button>
    </header>

    <main class="chat-container">
        <div id="messageContainer" class="message-container"></div>
        <div id="statusIndicator" class="status-indicator"></div>
    </main>

    <footer class="input-container">
        <textarea
            id="messageInput"
            class="message-input"
            placeholder="输入消息...（换行请按Shift+Enter）"
            rows="3"
        ></textarea>
        <button id="sendBtn" class="send-btn">
            <i class="fas fa-paper-plane"></i>
        </button>
        <button id="stopBtn" class="stop-btn-floating" title="停止生成" aria-label="停止生成">
            <i class="fas fa-stop"></i>
        </button>
    </footer>

    <script>
        document.getElementById('settingsBtn').addEventListener('click', function() {
            window.location.assign('config.html');
        });

        document.getElementById('conversationsBtn').addEventListener('click', function() {
            window.location.assign('conversations.html');
        });

        let currentConversation = [];
        let currentConversationGroupId = null;
        window.DEEPSEEK_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const MODEL_NAME = localStorage.getItem('chatModel') || 'minimax/minimax-m2:free';
        window.MODEL_NAME = MODEL_NAME;

        const LOCAL_PASSPHRASE = 'local_obfuscation_passphrase_2025';
        const ENCRYPTED_OPENROUTER_KEY = 'U2FsdGVkX18PSVwBhdx/XQSmTwr5UimvbPYKhcmoMNXytQwT4HgYIMh2Hl/BxCv/0zYPUjEzfprco76j74BEMQIjYwM5iIkP7VMSS1vKYLqbhNjbCqP369SdZlcmikUg';

        function decryptApiKey(encryptedBase64, passphrase) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedBase64, passphrase);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error('解密 API Key 失败：', e);
                return null;
            }
        }

        const OPENROUTER_API_KEY = decryptApiKey(ENCRYPTED_OPENROUTER_KEY, LOCAL_PASSPHRASE);
        window.OPENROUTER_API_KEY = OPENROUTER_API_KEY;
        const messageContainer = document.getElementById('messageContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusIndicator = document.getElementById('statusIndicator');

        function initApp() {
            if (window._appInitialized) return;
            window._appInitialized = true;

            console.log('initApp: attaching handlers');
            loadConversation();
            renderMessages();
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
                sendBtn.onclick = sendMessage;
            } else {
                console.error('sendBtn 未找到');
            }

            if (messageInput) {
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            stopBtn.addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                e.preventDefault();
                stopGeneration();
            });

            stopBtn.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            }, { passive: true });
        }

        document.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('load', initApp);

        function loadConversation() {
            const savedConversation = localStorage.getItem('deepseekConversation');
            if (savedConversation && savedConversation !== 'undefined') {
                try {
                    currentConversation = JSON.parse(savedConversation);
                } catch (err) {
                    console.error('解析 deepseekConversation 失败，已清理该键：', err, savedConversation);
                    currentConversation = [];
                    localStorage.removeItem('deepseekConversation');
                }
            }
            const grp = localStorage.getItem('deepseekConversationGroupId');
            currentConversationGroupId = (grp && grp !== 'undefined' && grp !== 'null') ? grp : null;
        }

        function setCurrentConversationGroup(groupId) {
            currentConversationGroupId = groupId;
            if (groupId) localStorage.setItem('deepseekConversationGroupId', groupId);
            else localStorage.removeItem('deepseekConversationGroupId');
        }

        function saveConversation() {
            localStorage.setItem('deepseekConversation', JSON.stringify(currentConversation));
        }

        function renderMessages() {
            messageContainer.innerHTML = '';

            currentConversation.forEach((message, index) => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.role === 'user' ? 'user-message' : 'ai-message'}`;
                if (message.role === 'assistant') {
                    try {
                        const rawHtml = marked.parse(message.content || '');
                        const cleanHtml = DOMPurify.sanitize(rawHtml);
                        messageElement.innerHTML = cleanHtml;
                    } catch (e) {
                        console.error('Markdown 渲染失败，退回纯文本显示：', e);
                        messageElement.textContent = message.content;
                    }
                } else {
                    messageElement.textContent = message.content;
                }

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';

                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(message.content);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'action-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteMessage(index);
                });

                actionsDiv.appendChild(copyBtn);
                actionsDiv.appendChild(deleteBtn);
                messageElement.appendChild(actionsDiv);

                messageContainer.appendChild(messageElement);
            });

            scrollToBottom();
        }

        async function sendMessage() {
            console.log('sendMessage invoked');
            try {
                const messageText = messageInput.value.trim();
                console.log('messageText length:', messageText.length);
                if (!messageText) return;

                const apiKey = OPENROUTER_API_KEY;
                console.log('using built-in OPENROUTER_API_KEY present:', !!apiKey);
                if (!apiKey) {
                    showStatus('内置 API Key 未配置，无法发送请求');
                    return;
                }

                currentConversation.push({ role: 'user', content: messageText });
                messageInput.value = '';
                saveConversation();
                renderMessages();

                showStatus('发送中...', true);
                stopBtn.style.display = 'flex';

                const aiMsgObj = { role: 'assistant', content: '' };
                currentConversation.push(aiMsgObj);
                saveConversation();
                renderMessages();

                await fetchDeepSeekResponseStream(apiKey, messageText, aiMsgObj);

                stopBtn.style.display = 'none';
                hideStatus();
                saveConversation();
                renderMessages();
            } catch (error) {
                console.error('发送消息失败:', error);
                showStatus('发送失败：' + (error && error.message ? error.message : '请重试'));
                setTimeout(hideStatus, 5000);
                stopBtn.style.display = 'none';
            }
        }

        function stopGeneration() {
            console.log("生成已中止");
            showStatus('已中止生成');
            stopBtn.style.display = 'none';
        }

        async function fetchDeepSeekResponseStream(apiKey, userMessage, aiMsgObj) {
            const messagesPayload = [
                ...currentConversation.filter(msg => msg.role !== 'assistant' || msg.content),
                { role: 'user', content: userMessage }
            ];

            const requestBody = {
                model: MODEL_NAME,
                messages: messagesPayload,
                temperature: 0.7,
                max_tokens: 40000,
                stream: true
            };

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            };

            const response = await fetch(DEEPSEEK_API_URL, {
                method: 'POST',
                headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                let errText = '';
                try { errText = await response.text(); } catch (e) { errText = '<无法读取响应体>'; }
                console.error('API 请求失败，status=', response.status, 'body=', errText);
                throw new Error(`API请求失败: ${response.status} ${response.statusText} ${errText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';
            let finished = false;

            while (!finished) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });

                const parts = buffer.split('\n\n');
                buffer = parts.pop();

                for (const part of parts) {
                    const line = part.trim();
                    if (!line) continue;
                    const lines = line.split('\n').map(l => l.trim()).filter(Boolean);
                    for (const l of lines) {
                        if (!l.startsWith('data:')) continue;
                        const data = l.slice(5).trim();
                        if (data === '[DONE]') {
                            finished = true;
                            break;
                        }
                        try {
                            const json = JSON.parse(data);
                            const delta = json.choices && json.choices[0] && (json.choices[0].delta ? json.choices[0].delta.content : (json.choices[0].text || ''));
                            if (delta) {
                                aiMsgObj.content += delta;
                                updateLastAssistantMessage(aiMsgObj.content);
                            }
                        } catch (err) {
                            console.debug('解析流片段失败（可能不是 JSON）：', err);
                        }
                    }
                    if (finished) break;
                }
            }
        }

        function updateLastAssistantMessage(content) {
            const nodes = messageContainer.querySelectorAll('.message.ai-message');
            const last = nodes && nodes.length ? nodes[nodes.length - 1] : null;
            if (!last) {
                renderMessages();
                return;
            }
            try {
                const rawHtml = marked.parse(content || '');
                last.innerHTML = DOMPurify.sanitize(rawHtml);
            } catch (e) {
                last.textContent = content;
            }

            const existingActions = last.querySelector('.message-actions');
            if (existingActions) existingActions.remove();

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'action-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                copyToClipboard(content);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteMessage(Array.from(messageContainer.children).indexOf(last));
            });

            actionsDiv.appendChild(copyBtn);
            actionsDiv.appendChild(deleteBtn);
            last.appendChild(actionsDiv);
            scrollToBottom();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('已复制到剪贴板');
                setTimeout(hideStatus, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                showStatus('复制失败');
                setTimeout(hideStatus, 2000);
            });
        }

        function deleteMessage(index) {
            currentConversation.splice(index, 1);
            saveConversation(); // 确保在删除后保存对话
            renderMessages();
        }

        function showStatus(text, isLoading = false) {
            statusIndicator.textContent = '';

            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading-animation';

                const dot1 = document.createElement('div');
                dot1.className = 'loading-dot';
                const dot2 = document.createElement('div');
                dot2.className = 'loading-dot';
                const dot3 = document.createElement('div');
                dot3.className = 'loading-dot';

                loadingDiv.appendChild(dot1);
                loadingDiv.appendChild(dot2);
                loadingDiv.appendChild(dot3);

                const textNode = document.createTextNode(text);
                statusIndicator.appendChild(loadingDiv);
                statusIndicator.appendChild(textNode);
            } else {
                statusIndicator.textContent = text;
            }
        }

        function hideStatus() {
            statusIndicator.textContent = '';
        }

        function scrollToBottom() {
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    </script>
</body>
</html>