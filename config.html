<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>设置 - FreeChat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-shell settings-app">
        <header class="app-bar">
            <div class="app-brand">
                <button id="backBtn" class="back-btn" title="返回">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div>
                    <h1>FreeChat 设置中心</h1>
                    <span class="app-pill">所有配置仅存储在本地设备</span>
                </div>
            </div>
            <div class="app-actions">
                <a href="index.html" class="settings-btn" title="返回聊天">
                    <i class="fas fa-comments"></i>
                </a>
            </div>
        </header>
        <main class="config-shell">
            <aside class="stepper">
                <div class="stepper-step active">
                    <span>1</span>
                    <div>
                        <strong>选择模型</strong>
                        <p>挑选默认聊天模型</p>
                    </div>
                </div>
                <div class="stepper-step">
                    <span>2</span>
                    <div>
                        <strong>模型参数</strong>
                        <p>设置温度、最大 Token 等</p>
                    </div>
                </div>
                <div class="stepper-step">
                    <span>3</span>
                    <div>
                        <strong>联网搜索</strong>
                        <p>配置 Web 插件参数</p>
                    </div>
                </div>
                <div class="stepper-step">
                    <span>4</span>
                    <div>
                        <strong>安全与摘要</strong>
                        <p>System 提示与本地说明</p>
                    </div>
                </div>
            </aside>
            <section class="config-panel">
                <div class="config-item">
                    <label for="customModelSelect" class="config-label">选择模型</label>
                    <select id="modelSelect" class="config-input" style="display:none;">
                <option value="">请选择模型</option>
                <option value="agentica-org/deepcoder-14b-preview:free">agentica-org/deepcoder-14b-preview:free</option>
                <option value="alibaba/tongyi-deepresearch-30b-a3b:free">alibaba/tongyi-deepresearch-30b-a3b:free</option>
                <option value="arliai/qwq-32b-arliai-rpr-v1:free">arliai/qwq-32b-arliai-rpr-v1:free</option>
                <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">cognitivecomputations/dolphin-mistral-24b-venice-edition:free</option>
                <option value="deepseek/deepseek-chat-v3-0324:free">deepseek/deepseek-chat-v3-0324:free</option>
                <option value="deepseek/deepseek-chat-v3.1:free">deepseek/deepseek-chat-v3.1:free</option>
                <option value="deepseek/deepseek-r1:free">deepseek/deepseek-r1:free</option>
                <option value="deepseek/deepseek-r1-0528:free">deepseek/deepseek-r1-0528:free</option>
                <option value="deepseek/deepseek-r1-0528-qwen3-8b:free">deepseek/deepseek-r1-0528-qwen3-8b:free</option>
                <option value="deepseek/deepseek-r1-distill-llama-70b:free">deepseek/deepseek-r1-distill-llama-70b:free</option>
                <option value="google/gemini-2.0-flash-exp:free">google/gemini-2.0-flash-exp:free</option>
                <option value="google/gemma-3-12b-it:free">google/gemma-3-12b-it:free</option>
                <option value="google/gemma-3-27b-it:free">google/gemma-3-27b-it:free</option>
                <option value="google/gemma-3-4b-it:free">google/gemma-3-4b-it:free</option>
                <option value="google/gemma-3n-e2b-it:free">google/gemma-3n-e2b-it:free</option>
                <option value="google/gemma-3n-e4b-it:free">google/gemma-3n-e4b-it:free</option>
                <option value="meituan/longcat-flash-chat:free">meituan/longcat-flash-chat:free</option>
                <option value="meta-llama/llama-3.2-3b-instruct:free">meta-llama/llama-3.2-3b-instruct:free</option>
                <option value="meta-llama/llama-3.3-8b-instruct:free">meta-llama/llama-3.3-8b-instruct:free</option>
                <option value="meta-llama/llama-3.3-70b-instruct:free">meta-llama/llama-3.3-70b-instruct:free</option>
                <option value="meta-llama/llama-4-maverick:free">meta-llama/llama-4-maverick:free</option>
                <option value="meta-llama/llama-4-scout:free">meta-llama/llama-4-scout:free</option>
                <option value="microsoft/mai-ds-r1:free">microsoft/mai-ds-r1:free</option>
                <option value="mistralai/mistral-7b-instruct:free">mistralai/mistral-7b-instruct:free</option>
                <option value="mistralai/mistral-nemo:free">mistralai/mistral-nemo:free</option>
                <option value="mistralai/mistral-small-24b-instruct-2501:free">mistralai/mistral-small-24b-instruct-2501:free</option>
                <option value="mistralai/mistral-small-3.1-24b-instruct:free">mistralai/mistral-small-3.1-24b-instruct:free</option>
                <option value="mistralai/mistral-small-3.2-24b-instruct:free">mistralai/mistral-small-3.2-24b-instruct:free</option>
                <option value="moonshotai/kimi-k2:free">moonshotai/kimi-k2:free</option>
                <option value="minimax/minimax-m2:free">minimax/minimax-m2:free</option>
                <option value="nvidia/nemotron-nano-12b-v2-vl:free">nvidia/nemotron-nano-12b-v2-vl:free</option>
                <option value="nvidia/nemotron-nano-9b-v2:free">nvidia/nemotron-nano-9b-v2:free</option>
                <option value="nousresearch/hermes-3-llama-3.1-405b:free">nousresearch/hermes-3-llama-3.1-405b:free</option>
                <option value="openai/gpt-oss-20b:free">openai/gpt-oss-20b:free</option>
                <option value="openrouter/polaris-alpha">openrouter/polaris-alpha</option>
                <option value="qwen/qwen-2.5-72b-instruct:free">qwen/qwen-2.5-72b-instruct:free</option>
                <option value="qwen/qwen-2.5-coder-32b-instruct:free">qwen/qwen-2.5-coder-32b-instruct:free</option>
                <option value="qwen/qwen2.5-vl-32b-instruct:free">qwen/qwen2.5-vl-32b-instruct:free</option>
                <option value="qwen/qwen3-14b:free">qwen/qwen3-14b:free</option>
                <option value="qwen/qwen3-4b:free">qwen/qwen3-4b:free</option>
                <option value="qwen/qwen3-30b-a3b:free">qwen/qwen3-30b-a3b:free</option>
                <option value="qwen/qwen3-235b-a22b:free">qwen/qwen3-235b-a22b:free</option>
                <option value="qwen/qwen3-coder:free">qwen/qwen3-coder:free</option>
                <option value="tngtech/deepseek-r1t-chimera:free">tngtech/deepseek-r1t-chimera:free</option>
                <option value="tngtech/deepseek-r1t2-chimera:free">tngtech/deepseek-r1t2-chimera:free</option>
                <option value="z-ai/glm-4.5-air:free">z-ai/glm-4.5-air:free</option>
                    <!-- 自定义下拉组件 -->
                    <div class="custom-select" id="customModelSelect" data-value="">
                        <button class="custom-select__trigger" aria-haspopup="listbox" aria-expanded="false" type="button">
                            <span class="custom-select__value">请选择模型</span>
                            <i class="fas fa-caret-down"></i>
                        </button>
                        <div class="custom-select__panel" role="listbox" tabindex="-1" aria-hidden="true">
                            <input class="custom-select__search" placeholder="搜索模型" aria-label="搜索模型">
                            <ul class="custom-select__options"></ul>
                        </div>
                    </div>
                </div>
                <div class="config-item">
                    <label class="config-label">模型参数</label>
                    <div class="config-grid two-col">
                        <div>
                            <label for="paramTemperature">Temperature</label>
                            <input id="paramTemperature" class="config-input" type="number" step="0.01" min="0" max="2" placeholder="0.7" />
                        </div>
                        <div>
                            <label for="paramTopP">Top P</label>
                            <input id="paramTopP" class="config-input" type="number" step="0.01" min="0" max="1" placeholder="0.9" />
                        </div>
                        <div>
                            <label for="paramMaxTokens">Max Tokens</label>
                            <input id="paramMaxTokens" class="config-input" type="number" step="1" min="1" placeholder="1024" />
                        </div>
                    </div>
                </div>
                <div class="config-item">
                    <label class="config-label">联网搜索设置</label>
                    <div class="config-grid two-col">
                        <div>
                            <label for="webEngineSelectCfg">搜索引擎</label>
                            <select id="webEngineSelectCfg" class="config-input">
                                <option value="auto">auto（默认）</option>
                                <option value="native">native</option>
                                <option value="exa">exa</option>
                            </select>
                        </div>
                        <div>
                            <label for="webMaxResultsInputCfg">最大结果数</label>
                            <input type="number" id="webMaxResultsInputCfg" class="config-input" min="1" max="10" step="1" placeholder="默认 5" />
                        </div>
                        <div>
                            <label for="webContextSizeSelectCfg">搜索上下文</label>
                            <select id="webContextSizeSelectCfg" class="config-input">
                                <option value="">不指定</option>
                                <option value="low">low</option>
                                <option value="medium">medium</option>
                                <option value="high">high</option>
                            </select>
                        </div>
                        <div>
                            <label for="webSearchPromptInputCfg">Search Prompt（可选）</label>
                            <textarea id="webSearchPromptInputCfg" class="config-input" rows="3" placeholder="留空使用默认提示"></textarea>
                        </div>
                    </div>
                </div>
                <div class="config-item">
                    <label for="globalSystemPrompt" class="config-label">全局 System 提示（可选）</label>
                    <textarea id="globalSystemPrompt" class="config-input" rows="4" placeholder="为所有会话添加额外指令"></textarea>
                </div>
                <div class="config-summary">
                    <h3>配置总览</h3>
                    <ul>
                        <li>模型：<span id="summaryModel">未选择</span></li>
                        <li>参数：<span id="summaryParams">默认</span></li>
                        <li>联网搜索：<span id="summaryWeb">关闭</span></li>
                        <li>System 提示：<span id="summarySystem">未设置</span></li>
                    </ul>
                </div>
                <div class="privacy-panel">
                    <strong>本地隐私与同步</strong>
                    <p>所有设置存储在本地 LocalStorage，可随时清除浏览器数据以重置。</p>
                    <p id="privacyStats">正在统计本地存储占用...</p>
                </div>
                <button id="saveConfigBtn" class="save-btn">保存设置</button>
                <div id="saveMessage" class="save-message"></div>
            </section>
        </main>
    </div>

    <script>
        /**
         * 文件名：config.html
         * 功能描述：FreeChat 设置页面，提供模型选择和配置保存功能
         */
        // 确保路径正确的返回按钮
        document.getElementById('backBtn').addEventListener('click', function() {
            window.location.assign('index.html');
        });
        const summaryModelEl = document.getElementById('summaryModel');
        const summaryParamsEl = document.getElementById('summaryParams');
        const summaryWebEl = document.getElementById('summaryWeb');
        const summarySystemEl = document.getElementById('summarySystem');
        const privacyStatsEl = document.getElementById('privacyStats');

        /**
         * 构建自定义下拉组件：从隐藏的原生 select 读取选项并在页面内渲染可搜索的列表
         * selectEl: 原生 <select> 元素（可为 null，若为 null 则不读取）
         */
        function buildCustomModelSelect(selectEl) {
            const container = document.getElementById('customModelSelect');
            if (!container) return;
            const trigger = container.querySelector('.custom-select__trigger');
            const valueEl = container.querySelector('.custom-select__value');
            const panel = container.querySelector('.custom-select__panel');
            const searchInput = container.querySelector('.custom-select__search');
            const optionsListEl = container.querySelector('.custom-select__options');

            // 从原生 select 提取选项数据
            const options = [];
            if (selectEl) {
                for (const opt of Array.from(selectEl.options)) {
                    if (!opt.value) continue;
                    options.push({ value: opt.value, label: opt.text });
                }
            }

            function renderList(filter = '') {
                const q = String(filter || '').trim().toLowerCase();
                optionsListEl.innerHTML = options
                    .filter(o => o.label.toLowerCase().includes(q) || o.value.toLowerCase().includes(q))
                    .map(o => `<li role="option" data-value="${o.value}" title="${o.label}">${o.label}</li>`).join('');
            }

            function openPanel() {
                panel.setAttribute('aria-hidden', 'false');
                trigger.setAttribute('aria-expanded', 'true');
                searchInput.focus();
            }
            function closePanel() {
                panel.setAttribute('aria-hidden', 'true');
                trigger.setAttribute('aria-expanded', 'false');
            }

            // 初始渲染
            renderList();

            // 事件：触发器切换
            trigger.addEventListener('click', (e) => {
                const expanded = trigger.getAttribute('aria-expanded') === 'true';
                if (expanded) closePanel(); else openPanel();
            });

            // 点击选项
            optionsListEl.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (!li) return;
                const v = li.dataset.value;
                const label = li.textContent;
                valueEl.textContent = label;
                // 同步到原生 select（隐藏）
                if (selectEl) selectEl.value = v;
                container.dataset.value = v;
                closePanel();
            });

            // 搜索输入
            searchInput.addEventListener('input', (e) => {
                renderList(e.target.value);
            });

            // 点击面板外部时关闭
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    closePanel();
                }
            });

            // 如果 localStorage 中已有选中模型，设置显示
            const saved = localStorage.getItem('chatModel');
            if (saved) {
                const found = options.find(o => o.value === saved);
                if (found) {
                    valueEl.textContent = found.label;
                    if (selectEl) selectEl.value = saved;
                    container.dataset.value = saved;
                }
            }
        }

        function summarizeTextLite(text, limit = 60) {
            const trimmed = String(text || '').replace(/\s+/g, ' ').trim();
            if (!trimmed) return '未设置';
            return trimmed.length > limit ? `${trimmed.slice(0, limit)}...` : trimmed;
        }

        function updateLiveSummary() {
            try {
                const modelName = localStorage.getItem('chatModel') || '未选择';
                if (summaryModelEl) summaryModelEl.textContent = modelName;
                const params = JSON.parse(localStorage.getItem('freechat.modelParams') || '{}');
                const temperature = typeof params.temperature === 'number' ? params.temperature : 0.7;
                const topP = typeof params.top_p === 'number' ? params.top_p : 0.9;
                const maxTokens = params.max_tokens || 1024;
                if (summaryParamsEl) summaryParamsEl.textContent = `T=${temperature}, TopP=${topP}, Max=${maxTokens}`;
                const webEnabled = (localStorage.getItem('freechat.web.enable') || 'false') === 'true';
                const engine = localStorage.getItem('freechat.web.engine') || 'auto';
                if (summaryWebEl) summaryWebEl.textContent = webEnabled ? `开启（${engine}）` : '关闭';
                const sysPrompt = localStorage.getItem('freechat.systemPrompt') || '';
                if (summarySystemEl) summarySystemEl.textContent = summarizeTextLite(sysPrompt, 80);
                if (privacyStatsEl) {
                    const convs = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                    privacyStatsEl.textContent = `已保存 ${convs.length} 个会话，localStorage 键数量 ${localStorage.length}`;
                }
            } catch (err) {
                console.error('更新配置概览失败：', err);
            }
        }

        /**
         * 尝试从 OpenRouter 实时更新模型列表，带本地缓存与简单回退策略
         * 返回值：若成功更新返回 true，失败返回 false（不抛异常）
         */
    async function updateModelListFromOpenRouter() {
        const apiUrl = 'https://openrouter.ai/api/v1/models';
        const cacheKey = 'openrouter.models.cache';
        const ttlKey = 'openrouter.models.ttlMs';
        const defaultTtl = 24 * 60 * 60 * 1000; // 24 小时
        try {
            // 若用户未配置代理，自动为本次测试写入一个常见的免费 CORS 代理示例（可手动删除或修改）
            if (!localStorage.getItem('openrouter.models.proxy')) {
                try {
                    localStorage.setItem('openrouter.models.proxy', 'https://api.allorigins.win/raw?url=');
                    console.info('已为调试自动写入默认代理键 openrouter.models.proxy = https://api.allorigins.win/raw?url=');
                } catch (e) {
                    console.info('无法写入 localStorage.openrouter.models.proxy：', e);
                }
            }

            const ttl = Number(localStorage.getItem(ttlKey)) || defaultTtl;
            const cached = JSON.parse(localStorage.getItem(cacheKey) || 'null');
            if (cached && (Date.now() - cached.ts) < ttl && Array.isArray(cached.models) && cached.models.length) {
                populateSelect(cached.models);
                return true;
            }

            // 尝试直接调用 OpenRouter 的 JSON API（更稳健）
            let res;
            try {
                res = await fetch(apiUrl, { credentials: 'omit' });
            } catch (directErr) {
                // 直接拉取失败（可能是网络或 CORS），如果用户配置了代理则尝试通过代理拉取
                const proxy = (localStorage.getItem('openrouter.models.proxy') || '').trim();
                if (proxy) {
                    try {
                        const proxyUrl = proxy + encodeURIComponent(apiUrl);
                        res = await fetch(proxyUrl, { credentials: 'omit' });
                    } catch (proxyErr) {
                        console.warn('通过代理拉取 OpenRouter 模型 API 也失败：', proxyErr);
                        console.info('若遇 CORS 问题，可在 localStorage 中设置键 `openrouter.models.proxy` 指向可用的 CORS 代理（例如 https://api.allorigins.win/raw?url=）');
                        return false;
                    }
                } else {
                    console.info('直接请求 OpenRouter API 失败；可在 localStorage.openrouter.models.proxy 设置代理 URL（例如 https://api.allorigins.win/raw?url=）');
                    return false;
                }
            }

            if (!res || !res.ok) {
                console.warn('OpenRouter API 返回非 2xx：', res && res.status);
                return false;
            }

            const json = await res.json();
            const list = Array.isArray(json?.data) ? json.data : [];
            const models = list.map(m => {
                const id = m.id || m.model || (m.name ? m.name : '');
                const label = m.name || id;
                const tags = Array.isArray(m.tags) ? m.tags : (m.tag ? [m.tag] : []);
                return id ? { value: id, label, tags } : null;
            }).filter(Boolean);

            // 仅保留带 "free" 标签或 id 包含 ":free" 的模型
            const freeModels = models.filter(item => {
                if (!item) return false;
                if (item.value && item.value.includes(':free')) return true;
                if (Array.isArray(item.tags) && item.tags.includes('free')) return true;
                return false;
            });

            if (!freeModels.length && !models.length) {
                console.warn('API 返回但未解析到有效模型项，回退为尝试解析 HTML 列表');
                // 作为回退，尝试解析 HTML 页面（老方法）
                try {
                    const pageUrl = 'https://openrouter.ai/models?fmt=cards&input_modalities=text&max_price=0&output_modalities=text';
                    let pageRes;
                    try {
                        pageRes = await fetch(pageUrl, { credentials: 'omit' });
                    } catch (pErr) {
                        const proxy = (localStorage.getItem('openrouter.models.proxy') || '').trim();
                        if (proxy) pageRes = await fetch(proxy + encodeURIComponent(pageUrl), { credentials: 'omit' });
                    }
                    if (pageRes && pageRes.ok) {
                        const text = await pageRes.text();
                        const found = Array.from(new Set((text.match(/[\w\-.]+\/[\w\-.]+(?::[\w\-.]+)?/g) || [])));
                        // 只取带 :free 的模型
                        const foundFree = found.filter(s => s.includes(':free'));
                        const fallbackModels = foundFree.sort().map(m => ({ value: m, label: m }));
                        if (fallbackModels.length) {
                            localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), models: fallbackModels }));
                            populateSelect(fallbackModels);
                            return true;
                        }
                    }
                } catch (fallbackErr) {
                    console.warn('HTML 回退解析也失败：', fallbackErr);
                }
                return false;
            }
            // 若解析到带 free 标签的模型则使用之，优先级：freeModels > models（仅当 freeModels 为空时考虑全量，但默认只要 freeModels 非空就用）
            const toUse = freeModels.length ? freeModels : [];
            if (!toUse.length) {
                console.warn('未找到带 free 标签的模型，已放弃使用非 free 模型以满足筛选要求');
                return false;
            }
            // 缓存并填充（models 为对象数组 {value,label}）
            localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), models: toUse }));
            populateSelect(toUse);
            return true;
        } catch (err) {
            console.warn('更新 OpenRouter 模型列表失败：', err);
            return false;
        }
    }

    // 将模型数组填充到隐藏的原生 select 中（支持字符串数组或对象数组 {value,label}）
    function populateSelect(models) {
        const select = document.getElementById('modelSelect');
        if (!select) return;
        const placeholder = '<option value="">请选择模型</option>';
        const optionsHtml = (models || []).map(item => {
            if (!item) return '';
            if (typeof item === 'string') {
                const v = item;
                return `<option value="${v}">${v}</option>`;
            } else if (typeof item === 'object') {
                const v = item.value || '';
                const l = item.label || v;
                return `<option value="${v}">${l}</option>`;
            } else {
                return '';
            }
        }).join('');
        select.innerHTML = placeholder + optionsHtml;
    }

        // 页面加载时获取保存的模型名称与联网搜索设置
        document.addEventListener('DOMContentLoaded', async () => {
            // 先读取已保存的模型名，延后应用到 select（避免被异步填充覆盖）
            const savedModel = localStorage.getItem('chatModel');

            // 尝试从 OpenRouter 拉取并更新模型列表（成功时会填充隐藏 select）
            const updated = await updateModelListFromOpenRouter();

            // 若有已保存模型，尝试应用（若该模型在列表中则会被选中）
            if (savedModel) {
                const sel = document.getElementById('modelSelect');
                if (sel) sel.value = savedModel;
            }

            // 构建自定义下拉（从隐藏的原生 select 读取数据并渲染）
            buildCustomModelSelect(document.getElementById('modelSelect'));

            // 若更新失败，短暂提示用户（不阻塞核心流程）
            if (!updated) {
                try {
                    const saveMessage = document.getElementById('saveMessage');
                    if (saveMessage) {
                        const prev = saveMessage.textContent;
                        saveMessage.textContent = '模型列表更新失败，使用本地列表';
                        saveMessage.classList.add('error');
                        setTimeout(() => {
                            saveMessage.textContent = prev || '';
                            saveMessage.classList.remove('error');
                        }, 3000);
                    }
                } catch (e) {
                    // 忽略提示失败，避免影响主流程
                }
            }

            // 读取并初始化：联网搜索设置（保持与主页面相同键名与默认值）
            try {
                const read = (k, d) => {
                    const v = localStorage.getItem(k);
                    return (v === null || v === undefined) ? d : v;
                };

                const engineEl = document.getElementById('webEngineSelectCfg');
                const maxEl = document.getElementById('webMaxResultsInputCfg');
                const ctxEl = document.getElementById('webContextSizeSelectCfg');
                const promptEl = document.getElementById('webSearchPromptInputCfg');

                const engine = read('freechat.web.engine', 'auto');
                engineEl.value = (engine === 'native' || engine === 'exa') ? engine : 'auto';
                const maxResults = Math.max(1, Math.min(10, Number(read('freechat.web.maxResults', '5')) || 5));
                maxEl.value = String(maxResults);
                const ctx = read('freechat.web.contextSize', '');
                ctxEl.value = (ctx === 'low' || ctx === 'medium' || ctx === 'high') ? ctx : '';
                promptEl.value = read('freechat.web.searchPrompt', '');
                // 读取并初始化：全局 system 提示与模型参数
                try {
                    const sysEl = document.getElementById('globalSystemPrompt');
                    if (sysEl) sysEl.value = read('freechat.systemPrompt', '');
                    const paramsRaw = localStorage.getItem('freechat.modelParams');
                    const params = paramsRaw ? JSON.parse(paramsRaw) : null;
                    const tempEl = document.getElementById('paramTemperature');
                    const topEl = document.getElementById('paramTopP');
                    const maxEl = document.getElementById('paramMaxTokens');
                    if (params) {
                        if (tempEl) tempEl.value = (typeof params.temperature !== 'undefined') ? String(params.temperature) : '';
                        if (topEl) topEl.value = (typeof params.top_p !== 'undefined') ? String(params.top_p) : '';
                        if (maxEl) maxEl.value = (typeof params.max_tokens !== 'undefined') ? String(params.max_tokens) : '';
                    }
                } catch (e) { console.error('初始化全局 system 提示与模型参数失败：', e); }
            } catch (e) {
                console.error('初始化 联网搜索设置 失败：', e);
            }

            // 保存按钮事件
            document.getElementById('saveConfigBtn').addEventListener('click', () => {
                try {
                    // 保存模型
                    const modelName = document.getElementById('modelSelect').value;
                    if (modelName) {
                        localStorage.setItem('chatModel', modelName);
                    }

                    // 保存：联网搜索设置（空值移除，数值范围保护）
                    const engineEl = document.getElementById('webEngineSelectCfg');
                    const maxEl = document.getElementById('webMaxResultsInputCfg');
                    const ctxEl = document.getElementById('webContextSizeSelectCfg');
                    const promptEl = document.getElementById('webSearchPromptInputCfg');

                    const write = (k, v) => {
                        if (v === '' || v === null || v === undefined) localStorage.removeItem(k);
                        else localStorage.setItem(k, String(v));
                    };

                    // 引擎：写入 auto/native/exa（保持与主页面一致）
                    const engine = engineEl.value === 'native' || engineEl.value === 'exa' ? engineEl.value : 'auto';
                    write('freechat.web.engine', engine);

                    // 最大结果数：范围 1..10
                    const maxVal = Math.max(1, Math.min(10, Number(maxEl.value) || 5));
                    write('freechat.web.maxResults', String(maxVal));

                    // 上下文强度：允许为空（为空则移除键）
                    const ctx = (ctxEl.value === 'low' || ctxEl.value === 'medium' || ctxEl.value === 'high') ? ctxEl.value : '';
                    write('freechat.web.contextSize', ctx);

                    // 自定义搜索提示：允许为空（为空则移除键）
                    const searchPrompt = (promptEl.value || '').trim();
                    write('freechat.web.searchPrompt', searchPrompt);
                    // 保存全局 systemPrompt 与模型参数
                    try {
                        const sysVal = (document.getElementById('globalSystemPrompt') && document.getElementById('globalSystemPrompt').value) || '';
                        if (sysVal && sysVal.trim()) localStorage.setItem('freechat.systemPrompt', sysVal.trim());
                        else localStorage.removeItem('freechat.systemPrompt');

                        const temp = parseFloat(document.getElementById('paramTemperature').value);
                        const top = parseFloat(document.getElementById('paramTopP').value);
                        const maxT = parseInt(document.getElementById('paramMaxTokens').value, 10);
                        const mp = {};
                        if (!Number.isNaN(temp)) mp.temperature = temp;
                        if (!Number.isNaN(top)) mp.top_p = top;
                        if (!Number.isNaN(maxT)) mp.max_tokens = maxT;
                        // 若没有任何数值字段则移除键，否则写入 JSON
                        if (Object.keys(mp).length === 0) localStorage.removeItem('freechat.modelParams');
                        else localStorage.setItem('freechat.modelParams', JSON.stringify(mp));
                    } catch (e) { console.error('保存全局 system 提示/模型参数失败：', e); }

                    const saveMessage = document.getElementById('saveMessage');
                    saveMessage.textContent = '保存成功！';
                    saveMessage.classList.add('success');

                    // 2秒后隐藏提示消息
                    setTimeout(() => {
                        saveMessage.textContent = '';
                        saveMessage.classList.remove('success');
                    }, 2000);
                } catch (e) {
                    console.error('保存设置失败：', e);
                }
                updateLiveSummary();
            });
            updateLiveSummary();
        });
    </script>
</body>
</html>