<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼šè¯ç®¡ç† - FreeChat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="prompts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="logger.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div class="app-shell conversation-app">
        <header class="app-bar">
            <div class="app-brand">
                <button id="backBtn" class="app-menu-btn back-btn" title="è¿”å›" aria-label="è¿”å›èŠå¤©">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <img src="icon/logo.png" alt="FreeChat" class="welcome-logo" style="height:40px;width:40px;border-radius:10px;" />
                <div class="brand-text">
                    <h1>FreeChat ä¼šè¯ç®¡ç†</h1>
                    <span class="app-pill">æœ¬åœ°å­˜å‚¨ Â· ä¸ä¸Šäº‘</span>
                </div>
            </div>
            <div class="app-context">
                <strong>æ•´ç†å†å²å¯¹è¯ä¸åˆ†ç»„è®°å¿†</strong>
                <span>æ‰¹é‡ç§»åŠ¨ã€å¯¼å‡ºæˆ–åˆ é™¤ Â· æ‰€æœ‰æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœº</span>
            </div>
            <div class="app-actions">
                <button id="clearLogsBtn" class="settings-btn" title="æ¸…ç©ºæ—¥å¿—" aria-label="æ¸…ç©ºæ—¥å¿—">
                    <i class="fas fa-trash"></i>
                </button>
                <button id="newChatBtn" class="settings-btn" title="å¼€å§‹æ–°ä¼šè¯" aria-label="å¼€å§‹æ–°ä¼šè¯">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </header>
        <main>
            <section class="conversation-layout">
                <aside class="conversation-sidebar">
                    <div class="group-controls">
                        <label class="config-label">åˆ›å»ºåˆ†ç»„</label>
                        <div class="config-grid">
                            <input id="newGroupName" placeholder="æ–°åˆ†ç»„å" />
                            <button id="createGroupBtn" class="drawer-primary">åˆ›å»ºåˆ†ç»„</button>
                        </div>
                        <button id="saveCurrentBtn" class="drawer-primary save-current-btn">ä¿å­˜å½“å‰ä¼šè¯</button>
                    </div>
                    <div id="groupListPanel" class="group-list-panel"></div>
                    <div class="privacy-panel">
                        <strong>æ•°æ®å®‰å…¨è¯´æ˜</strong>
                        <p>æ‰€æœ‰ä¼šè¯ã€åˆ†ç»„ä¸è®°å¿†éƒ½ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ / App å†…ï¼Œå¯éšæ—¶å¯¼å‡ºæˆ–åˆ é™¤ã€‚</p>
                        <button id="exportAllBtn" class="drawer-primary">å¯¼å‡ºå…¨éƒ¨ä¼šè¯</button>
                    </div>
                </aside>
                <section class="conversation-content">
                    <div class="bulk-actions">
                        <label class="pill">
                            <input type="checkbox" id="multiSelectToggle" />
                            å¯ç”¨å¤šé€‰
                        </label>
                        <span id="selectedCountLabel">å·²é€‰æ‹© 0 é¡¹</span>
                        <div class="bulk-buttons">
                            <button id="bulkMoveBtn" class="bulk-btn" disabled>ç§»åŠ¨åˆ°åˆ†ç»„</button>
                            <button id="bulkDeleteBtn" class="bulk-btn bulk-btn-danger" disabled>æ‰¹é‡åˆ é™¤</button>
                            <button id="bulkExportBtn" class="bulk-btn" disabled>æ‰¹é‡å¯¼å‡º</button>
                        </div>
                    </div>
                    <div id="conversationsList" class="conversation-cards"></div>
                    <div id="conversationsEmptyState" class="empty-state" style="display:none;">
                        <img src="icon/logo.png" alt="FreeChat" />
                        <p>æš‚æœªä¿å­˜ä¼šè¯ï¼Œç«‹å³å¼€å§‹æ–°çš„ç§å¯†å¯¹è¯å§ã€‚</p>
                    </div>
                </section>
            </section>
        </main>
    </div>

    <!-- æ–°å»ºä¼šè¯åˆ†ç»„é€‰æ‹©æ¨¡æ€ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="newChatGroupModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <h3 class="modal-title">æ˜¯å¦å°†æ–°ä¼šè¯åŠ å…¥å·²æœ‰åˆ†ç»„ï¼Ÿ</h3>
            <p class="modal-desc">å¯ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåˆ†ç»„ï¼ˆå¯é€‰ï¼‰ï¼Œå¹¶ä¸ºæ–°ä¼šè¯å‘½åã€‚</p>
            <input id="newChatNameInput" class="modal-input" placeholder="è¾“å…¥ä¼šè¯åç§°ï¼ˆå¯é€‰ï¼‰" maxlength="50" />
            <select id="groupSelect" class="modal-select">
                <option value="">æœªåŠ å…¥åˆ†ç»„</option>
            </select>
            <div id="noGroupHint" class="modal-desc" style="display:none;">å½“å‰æ²¡æœ‰å¯ç”¨åˆ†ç»„ï¼Œå¯ç›´æ¥ç‚¹å‡»â€œè·³è¿‡â€ã€‚</div>
            <div class="modal-actions">
                <button id="groupModalConfirmBtn">ç¡®è®¤</button>
                <button id="groupModalSkipBtn">è·³è¿‡</button>
                <button id="groupModalCancelBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * æ–‡ä»¶åï¼šconversations.html
         * åŠŸèƒ½æè¿°ï¼šFreeChat ä¼šè¯ç®¡ç†é¡µé¢ï¼Œæä¾›ä¼šè¯åˆ—è¡¨å±•ç¤ºã€ä¿å­˜ã€åŠ è½½ã€åˆ é™¤ã€åˆ†ç»„ç®¡ç†ã€ä¼šè¯è®°å¿†ç”Ÿæˆç­‰åŠŸèƒ½
         */
        // ä¸ index ä¿æŒä¸€è‡´çš„æ¨¡å‹ä¸ç«¯ç‚¹é…ç½®
        window.DEEPSEEK_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        window.MODEL_NAME = localStorage.getItem('chatModel') || 'minimax/minimax-m2:free';

        // å¯é€‰çš„å†…ç½® OpenRouter Key è§£å¯†ï¼ˆä»…æ¼”ç¤ºç”¨é€”ï¼‰
        const LOCAL_PASSPHRASE = 'local_obfuscation_passphrase_2025';
        const ENCRYPTED_OPENROUTER_KEY = 'U2FsdGVkX18PSVwBhdx/XQSmTwr5UimvbPYKhcmoMNXytQwT4HgYIMh2Hl/BxCv/0zYPUjEzfprco76j74BEMQIjYwM5iIkP7VMSS1vKYLqbhNjbCqP369SdZlcmikUg';
        function decryptApiKey(encryptedBase64, passphrase) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedBase64, passphrase);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (_) { return null; }
        }
        window.OPENROUTER_API_KEY = decryptApiKey(ENCRYPTED_OPENROUTER_KEY, LOCAL_PASSPHRASE);
        const groupListPanel = document.getElementById('groupListPanel');
        const multiSelectToggle = document.getElementById('multiSelectToggle');
        const bulkMoveBtn = document.getElementById('bulkMoveBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const bulkExportBtn = document.getElementById('bulkExportBtn');
        const selectedCountLabel = document.getElementById('selectedCountLabel');
        const conversationsEmptyState = document.getElementById('conversationsEmptyState');
        const exportAllBtn = document.getElementById('exportAllBtn');
        const selectedConversationIds = new Set();
        let multiSelectMode = false;

        // æœ¬åœ°å­˜å‚¨å…¼å®¹è¿ç§»ï¼šå°†å†å²å­—æ®µå›å¡«åˆ°ç°ç”¨å­—æ®µï¼ˆä¸€æ¬¡æ€§ã€å¤±è´¥å¿½ç•¥ï¼‰
        (function migrateStorageCompat(){
            try {
                let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations')||'[]');
                let changed = false;
                for (const c of saved) {
                    if (c && c.memory && !c.summary) { c.summary = c.memory; changed = true; }
                }
                if (changed) localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));

                let groups = JSON.parse(localStorage.getItem('conversationGroups')||'[]');
                let gChanged = false;
                for (const g of groups) {
                    if (g && g.groupMemory && !g.memorySummary) { g.memorySummary = g.groupMemory; gChanged = true; }
                }
                if (gChanged) localStorage.setItem('conversationGroups', JSON.stringify(groups));
            } catch(_) { /* è¿ç§»å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ */ }
        })();

        function updateBulkActions() {
            const count = selectedConversationIds.size;
            if (selectedCountLabel) selectedCountLabel.textContent = `å·²é€‰æ‹© ${count} é¡¹`;
            const disabled = !count;
            [bulkMoveBtn, bulkDeleteBtn, bulkExportBtn].forEach(btn => {
                if (btn) btn.disabled = disabled;
            });
        }

        function handleSelectionChange(conversationId, checked) {
            if (checked) selectedConversationIds.add(conversationId);
            else selectedConversationIds.delete(conversationId);
            updateBulkActions();
        }

        /**
         * å¡«å……åˆ†ç»„ä¸‹æ‹‰
         * åŠŸèƒ½ï¼šä» localStorage è¯»å–åˆ†ç»„å¹¶å¡«å……ä¸‹æ‹‰æ¡†ï¼Œè‹¥æ— åˆ†ç»„åˆ™æ˜¾ç¤ºæç¤º
         * å‚æ•°ï¼šæ— 
         * è¿”å›å€¼ï¼šæ— 
         */
        function populateGroupSelect() {
            const select = document.getElementById('groupSelect');
            const hint = document.getElementById('noGroupHint');
            if (!select) return;
            // ä¿ç•™ç¬¬ä¸€ä¸ªâ€œæœªåŠ å…¥åˆ†ç»„â€é€‰é¡¹ï¼Œæ¸…ç†å…¶åé¡¹
            while (select.options.length > 1) select.remove(1);
            try {
                const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                if (groups.length === 0) {
                    if (hint) hint.style.display = 'block';
                    return;
                }
                if (hint) hint.style.display = 'none';
                groups.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.id;
                    opt.textContent = g.name;
                    select.appendChild(opt);
                });
            } catch (_) {
                if (hint) hint.style.display = 'block';
            }
        }

        /**
         * æ‰“å¼€/å…³é—­ æ¨¡æ€
         */
        function openNewChatGroupModal() {
            populateGroupSelect();
            const modal = document.getElementById('newChatGroupModal');
            if (modal) modal.style.display = 'flex';
        }
        function closeNewChatGroupModal() {
            const modal = document.getElementById('newChatGroupModal');
            if (modal) modal.style.display = 'none';
        }
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ‰€æœ‰ä¿å­˜çš„ä¼šè¯
        document.addEventListener('DOMContentLoaded', () => {
            renderConversationsList();
            updateBulkActions();
            if (multiSelectToggle) {
                multiSelectToggle.addEventListener('change', () => {
                    multiSelectMode = multiSelectToggle.checked;
                    if (!multiSelectMode) selectedConversationIds.clear();
                    renderConversationsList();
                    updateBulkActions();
                });
            }
            if (bulkMoveBtn) bulkMoveBtn.addEventListener('click', handleBulkMove);
            if (bulkDeleteBtn) bulkDeleteBtn.addEventListener('click', handleBulkDelete);
            if (bulkExportBtn) bulkExportBtn.addEventListener('click', handleBulkExport);
            if (exportAllBtn) exportAllBtn.addEventListener('click', exportAllConversations);

            // è¿”å›æŒ‰é’®äº‹ä»¶
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // æ–°å»ºä¼šè¯æŒ‰é’®ï¼šç›´æ¥å¼¹å‡ºåˆ†ç»„é€‰æ‹©ï¼ˆä¸å†å¼ºåˆ¶ä¿å­˜å½“å‰ä¼šè¯ï¼‰
            document.getElementById('newChatBtn').addEventListener('click', async () => {
                try {
                    const confirmed = await showConfirmModal('ç¡®å®šè¦å¼€å§‹æ–°ä¼šè¯å—ï¼Ÿ');
                    if (confirmed) {
                        openNewChatGroupModal();
                    }
                } catch (e) { console.error('newChatBtn å¼‚å¸¸ï¼š', e); }
            });

            // æ—¥å¿—å¯¼å‡ºä¸æ¸…ç©ºæŒ‰é’®
            try {
                const clearBtn = document.getElementById('clearLogsBtn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', async () => {
                        try {
                            const confirmed = await showConfirmModal('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚');
                            if (confirmed) {
                                try { window.Logger && window.Logger.clear(); } catch (_) {}
                            }
                        } catch (e) { console.error('clearLogsBtn å¼‚å¸¸ï¼š', e); }
                    });
                }
            } catch (_) { /* å¿½ç•¥å¼‚å¸¸ */ }

            // ä¿å­˜å½“å‰ä¼šè¯æŒ‰é’®
            document.getElementById('saveCurrentBtn').addEventListener('click', () => {
                const currentConversation = localStorage.getItem('deepseekConversation');
                if (currentConversation && JSON.parse(currentConversation).length > 0) {
                    const name = prompt('è¯·è¾“å…¥ä¼šè¯åç§°ï¼š', 'æ–°ä¼šè¯');
                    if (name) {
                        saveCurrentConversation(name);
                        renderConversationsList();
                    }
                } else {
                    alert('å½“å‰æ²¡æœ‰å¯ä¿å­˜çš„ä¼šè¯å†…å®¹');
                }
            });

            // åˆ›å»ºåˆ†ç»„æŒ‰é’®
            document.getElementById('createGroupBtn').addEventListener('click', () => {
                const nameInput = document.getElementById('newGroupName');
                const name = nameInput.value && nameInput.value.trim();
                if (!name) { alert('è¯·è¾“å…¥åˆ†ç»„åç§°'); return; }
                const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                const id = Date.now().toString();
                groups.push({ id, name, memorySummary: null, updatedAt: new Date().toISOString() });
                localStorage.setItem('conversationGroups', JSON.stringify(groups));
                nameInput.value = '';
                renderConversationsList();
            });

            // ç»‘å®šæ¨¡æ€æŒ‰é’®äº‹ä»¶
            try {
                document.getElementById('groupModalConfirmBtn').addEventListener('click', () => {
                    // æ ¹æ®é€‰æ‹©è®¾ç½®åˆ†ç»„
                    const sel = document.getElementById('groupSelect');
                    const val = sel ? (sel.value || '') : '';
                    if (val) localStorage.setItem('deepseekConversationGroupId', val);
                    else localStorage.removeItem('deepseekConversationGroupId');
                    // è¯»å–åç§°è¾“å…¥å¹¶æš‚å­˜åˆ° localStorageï¼Œä¾› index é¦–æ¬¡åˆ›å»ºæŒä¹…ä¼šè¯æ—¶ä½¿ç”¨
                    const nameEl = document.getElementById('newChatNameInput');
                    const nameVal = nameEl && nameEl.value ? nameEl.value.trim() : '';
                    if (nameVal) localStorage.setItem('deepseekNewConversationName', nameVal);
                    else localStorage.removeItem('deepseekNewConversationName');
                    // æ¸…ç©ºå½“å‰ä¸´æ—¶ä¼šè¯ä¸æ—§IDï¼Œè¿›å…¥æ–°ä¼šè¯
                    localStorage.setItem('deepseekConversation', JSON.stringify([]));
                    localStorage.removeItem('deepseekConversationId');
                    closeNewChatGroupModal();
                    window.location.href = 'index.html';
                });
                document.getElementById('groupModalSkipBtn').addEventListener('click', () => {
                    // è·³è¿‡ï¼šä¸è®¾ç½®åˆ†ç»„
                    localStorage.setItem('deepseekConversation', JSON.stringify([]));
                    localStorage.removeItem('deepseekConversationGroupId');
                    localStorage.removeItem('deepseekConversationId');
                    localStorage.removeItem('deepseekNewConversationName');
                    closeNewChatGroupModal();
                    window.location.href = 'index.html';
                });
                document.getElementById('groupModalCancelBtn').addEventListener('click', () => {
                    // å–æ¶ˆï¼šä»…å…³é—­æ¨¡æ€
                    closeNewChatGroupModal();
                });
            } catch (e) { /* å¿½ç•¥äº‹ä»¶ç»‘å®šå¼‚å¸¸ */ }
        });

        /**
         * ä¿å­˜å½“å‰ä¼šè¯
         * åŠŸèƒ½ï¼šå°†å½“å‰ä¼šè¯ä¿å­˜åˆ°localStorageï¼Œå¹¶å¼‚æ­¥è°ƒç”¨APIç”Ÿæˆä¼šè¯æ‘˜è¦ï¼Œå¦‚æœä¼šè¯å±äºåˆ†ç»„åˆ™æ›´æ–°åˆ†ç»„è®°å¿†
         * å‚æ•°ï¼šname - ä¼šè¯åç§°
         * è¿”å›å€¼ï¼šPromiseï¼Œæ— è¿”å›å€¼
         */
        async function saveCurrentConversation(name) {
            const currentConversation = localStorage.getItem('deepseekConversation');
            if (!currentConversation) return;

                let savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');

                // ç”Ÿæˆå”¯ä¸€ID
                const conversationId = Date.now().toString();

            const conversationObj = {
                    id: conversationId,
                    name: name,
                messages: JSON.parse(currentConversation),
                summary: null,
                groupId: localStorage.getItem('deepseekConversationGroupId') || null,
                model: window.MODEL_NAME,
                // ä¿å­˜ä¼šè¯æ—¶åŒæ—¶æŠŠå½“å‰æœ‰æ•ˆæ¨¡å‹å‚æ•°ä¸å…¨å±€/ä¼šè¯çº§ systemPrompt ä¸€å¹¶ä¿å­˜ï¼Œä¾¿äºå†å²å›æ”¾
                modelParams: (function(){
                    try {
                        const tmp = localStorage.getItem('deepseekConversationModelParams') || localStorage.getItem('freechat.modelParams') || null;
                        return tmp ? JSON.parse(tmp) : null;
                    } catch (_) {
                        try { return JSON.parse(localStorage.getItem('freechat.modelParams')||'null'); } catch(e){ return null; }
                    }
                })(),
                systemPrompt: (function(){ try { return localStorage.getItem('freechat.systemPrompt') || ''; } catch(_) { return ''; } })(),
                updatedAt: new Date().toISOString()
            };

            // å…ˆä¿å­˜ä¼šè¯ä¸»ä½“
            savedConversations.push(conversationObj);
            localStorage.setItem('savedDeepseekConversations', JSON.stringify(savedConversations));

            // æ”¹ä¸ºå…¥é˜Ÿå¼‚æ­¥ç”Ÿæˆä¼šè¯è®°å¿†ï¼Œé¿å…é˜»å¡ UI ä¸»æµç¨‹
            try {
                const apiKey = (window.OPENROUTER_API_KEY || localStorage.getItem('deepseekApiKey'));
                if (apiKey) {
                    if (!window.PROMPTS || !window.PROMPTS.SESSION_SUMMARY) {
                        throw new Error('PROMPTS.SESSION_SUMMARY æœªæ‰¾åˆ°ï¼Œæ— æ³•ç”Ÿæˆä¼šè¯è®°å¿†ï¼Œè¯·ç¡®ä¿ prompts.js å·²åŠ è½½ä¸”åŒ…å« SESSION_SUMMARY');
                    }
                    const systemPrompt = window.PROMPTS.SESSION_SUMMARY;
                    let savedForSummary = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                    const savedIdxForThis = savedForSummary.findIndex(c => c.id === conversationId);
                    const messagesForSummary = (savedIdxForThis !== -1 && savedForSummary[savedIdxForThis].messages && savedForSummary[savedIdxForThis].messages.length > 0)
                        ? savedForSummary[savedIdxForThis].messages
                        : conversationObj.messages;
                    const userContent = messagesForSummary.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\\n');
                    const convModel = (savedIdxForThis !== -1 && savedForSummary[savedIdxForThis].model) || (conversationObj && conversationObj.model) || null;
                    const modelToUse = convModel || (window.MODEL_NAME || 'minimax/minimax-m2:free');
                    const url = (window.DEEPSEEK_API_URL || 'https://openrouter.ai/api/v1/chat/completions');
                    const requestBody = { model: modelToUse, messages: [ { role: 'system', content: systemPrompt }, { role: 'user', content: userContent } ], temperature: 0.2 };
                    const payload = { apiKey: apiKey, url: url, requestBody: requestBody, msgCount: messagesForSummary.length, groupId: conversationObj.groupId || null, maxAttempts: 2 };
                    enqueueMemoryJob(conversationId, 'session', payload);
                }
            } catch (err) {
                console.error('ç”Ÿæˆä¼šè¯è®°å¿†å…¥é˜Ÿå¤±è´¥ï¼š', err);
                try { window.Logger && window.Logger.error({ type: 'summary_request', endpoint: (window.DEEPSEEK_API_URL || ''), model: (window.MODEL_NAME || '') }, err); } catch (_) {}
            }
        }

        /**
         * æ¸²æŸ“ä¼šè¯åˆ—è¡¨ï¼ˆLegacy ç‰ˆæœ¬ï¼Œç”¨äºä¿ç•™æ—§é€»è¾‘ï¼Œåç»­å°†é€æ­¥ç§»é™¤ï¼‰
         */
        function legacyRenderConversationsList() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '';

            const savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');

            if (savedConversations.length === 0 && groups.length === 0) {
                conversationsList.innerHTML = '<div class="no-conversations">æš‚æ— ä¿å­˜çš„ä¼šè¯</div>';
                return;
            }

            // ä¸ºæ¯ä¸ªåˆ†ç»„åˆ›å»ºä¸€ä¸ªæŠ˜å çš„ details å…ƒç´ 
            groups.forEach(group => {
                const groupDetails = document.createElement('details');
                groupDetails.className = 'conversation-group';

                const summary = document.createElement('summary');
                summary.innerHTML = `${group.name} <small class="group-meta">${group.memorySummary ? '(æœ‰åˆ†ç»„è®°å¿†)' : ''}</small>`;
                // æ·»åŠ é‡å‘½åä¸åˆ é™¤æŒ‰é’®åˆ°åˆ†ç»„æ ‡é¢˜
                const renameBtn = document.createElement('button');
                renameBtn.className = 'group-rename-btn';
                renameBtn.innerHTML = '<i class="fas fa-edit"></i>';
                renameBtn.title = 'é‡å‘½ååˆ†ç»„';
                renameBtn.style.marginLeft = '8px';
                renameBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        const newName = await showInputModal({ title: 'é‡å‘½ååˆ†ç»„', label: 'æ–°çš„åˆ†ç»„åç§°', value: group.name, placeholder: 'è¾“å…¥æ–°çš„åˆ†ç»„åç§°' });
                        if (newName !== null && String(newName).trim() !== '') {
                            let groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                            const idx = groups.findIndex(g => g.id === group.id);
                            if (idx !== -1) {
                                groups[idx].name = String(newName).trim();
                                groups[idx].updatedAt = new Date().toISOString();
                                localStorage.setItem('conversationGroups', JSON.stringify(groups));
                                renderConversationsList();
                            }
                        }
                    } catch (err) { console.error('åˆ†ç»„é‡å‘½åå¼‚å¸¸ï¼š', err); }
                });

                const delBtn = document.createElement('button');
                delBtn.className = 'group-delete-btn';
                delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                delBtn.title = 'åˆ é™¤åˆ†ç»„';
                delBtn.style.marginLeft = '8px';
                delBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        const confirmed = await showConfirmModal('åˆ é™¤åˆ†ç»„å°†æŠŠè¯¥åˆ†ç»„ä¸‹çš„ä¼šè¯ç§»åŠ¨åˆ°æœªåˆ†ç»„ï¼Œç¡®å®šåˆ é™¤ï¼Ÿ');
                        if (!confirmed) return;
                        let groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                        groups = groups.filter(g => g.id !== group.id);
                        localStorage.setItem('conversationGroups', JSON.stringify(groups));
                        // å°†è¯¥ç»„å†…ä¼šè¯ç§»åŠ¨åˆ°æœªåˆ†ç»„
                        let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                        saved = saved.map(c => c.groupId === group.id ? Object.assign({}, c, { groupId: null, updatedAt: new Date().toISOString() }) : c);
                        localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                        renderConversationsList();
                    } catch (err) { console.error('åˆ é™¤åˆ†ç»„å¼‚å¸¸ï¼š', err); }
                });

                // åˆ†ç»„è®°å¿†æ˜¾ç¤ºåŒºï¼ˆé»˜è®¤éšè—ï¼‰ï¼Œæä¾›æŸ¥çœ‹åˆ†ç»„è®°å¿†åŠŸèƒ½
                const memoryDiv = document.createElement('div');
                // ä½¿ç”¨ç»Ÿä¸€ç±»åï¼Œæ ·å¼ç”± CSS æ§åˆ¶ï¼›ä»…é€šè¿‡ style.display æ§åˆ¶æ˜¾ç¤º/éšè—
                memoryDiv.className = 'group-memory conversation-summary-content';
                memoryDiv.style.display = 'none';
                memoryDiv.innerHTML = group.memorySummary ? `<strong>åˆ†ç»„è®°å¿†ï¼š</strong><div>${group.memorySummary}</div>` : '<i class="small-muted">æš‚æ— åˆ†ç»„è®°å¿†</i>';

                const viewMemoryBtn = document.createElement('button');
                viewMemoryBtn.className = 'view-memory-btn';
                viewMemoryBtn.textContent = group.memorySummary ? 'æŸ¥çœ‹åˆ†ç»„è®°å¿†' : 'æš‚æ— åˆ†ç»„è®°å¿†';
                viewMemoryBtn.style.marginLeft = '8px';
                viewMemoryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (memoryDiv.style.display === 'none') {
                        memoryDiv.style.display = 'block';
                        viewMemoryBtn.textContent = 'éšè—åˆ†ç»„è®°å¿†';
                    } else {
                        memoryDiv.style.display = 'none';
                        viewMemoryBtn.textContent = group.memorySummary ? 'æŸ¥çœ‹åˆ†ç»„è®°å¿†' : 'æš‚æ— åˆ†ç»„è®°å¿†';
                    }
                });
                // å°†æŸ¥çœ‹æŒ‰é’®æ·»åŠ åˆ° summaryï¼ˆåœ¨ä¹‹å appendï¼‰

                summary.appendChild(renameBtn);
                summary.appendChild(delBtn);
                summary.appendChild(viewMemoryBtn);
                // åˆ†ç»„é‡æ–°æ‘˜è¦æŒ‰é’®
                const regenGroupBtn = document.createElement('button');
                regenGroupBtn.className = 'group-regen-btn';
                regenGroupBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                regenGroupBtn.title = 'é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†';
                regenGroupBtn.style.marginLeft = '8px';
                regenGroupBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        const confirmed = await showConfirmModal('ç¡®å®šè¦ä¸ºè¯¥åˆ†ç»„é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†å—ï¼Ÿå¯èƒ½äº§ç”ŸAPIè°ƒç”¨è´¹ç”¨ã€‚');
                        if (!confirmed) return;
                        await updateGroupMemory(group.id);
                        // updateGroupMemory å†…ä¼šä¿å­˜ memorySummary
                        renderConversationsList();
                        alert('åˆ†ç»„è®°å¿†å·²æ›´æ–°');
                    } catch (err) {
                        console.error('é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†å¤±è´¥ï¼š', err);
                        alert('é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
                    }
                });
                summary.appendChild(regenGroupBtn);
                groupDetails.appendChild(summary);
                // åœ¨ summary åæ’å…¥åˆ†ç»„è®°å¿†å±•ç¤ºåŒº
                groupDetails.appendChild(memoryDiv);

                const list = document.createElement('div');
                list.className = 'group-list';

                // åç»­ä¼šåˆ›å»º memoryDiv å’Œ viewMemoryBtnï¼Œé¿å…é‡å¤å£°æ˜

                const groupConvs = savedConversations.filter(c => c.groupId === group.id)
                    .sort((a, b) => new Date(b.updatedAt || b.timestamp || 0) - new Date(a.updatedAt || a.timestamp || 0));

                groupConvs.forEach(conversation => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item';
                    const date = new Date(conversation.updatedAt || conversation.timestamp);
                    const formattedTime = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    item.innerHTML = `
                        <div class="conversation-info">
                            <h3 class="conversation-name">${conversation.name}<span class="model-badge">${conversation.model || 'æœªè®°å½•'}</span></h3>
                            <p class="conversation-time">${formattedTime}</p>
                            <button class="toggle-summary-btn">æŸ¥çœ‹ä¼šè¯è®°å¿†</button>
                            <div class="conversation-summary-content" style="display:none;">${conversation.summary ? conversation.summary : '<i class="small-muted">è®°å¿†ç”Ÿæˆä¸­æˆ–ä¸å­˜åœ¨</i>'}</div>
                        </div>
                        <div class="conversation-actions">
                            <button class="load-btn" data-id="${conversation.id}"><i class="fas fa-download"></i> åŠ è½½</button>
                            <button class="regenerate-summary-btn" data-id="${conversation.id}" title="é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†">ğŸ”</button>
                            <button class="rename-conv-btn" data-id="${conversation.id}"><i class="fas fa-edit"></i></button>
                            <button class="move-conv-btn" data-id="${conversation.id}"><i class="fas fa-folder-open"></i></button>
                            <button class="delete-conv-btn" data-id="${conversation.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(item);

                    // ç»‘å®šæ‘˜è¦æ˜¾ç¤ºåˆ‡æ¢
                    const toggleBtn = item.querySelector('.toggle-summary-btn');
                    const summaryDiv = item.querySelector('.conversation-summary-content');
                    if (toggleBtn && summaryDiv) {
                        toggleBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (summaryDiv.style.display === 'none') {
                                summaryDiv.style.display = 'block';
                                toggleBtn.textContent = 'éšè—ä¼šè¯è®°å¿†';
                            } else {
                                summaryDiv.style.display = 'none';
                                toggleBtn.textContent = 'æŸ¥çœ‹ä¼šè¯è®°å¿†';
                            }
                        });
                    }
                });

                groupDetails.appendChild(list);
                conversationsList.appendChild(groupDetails);
            });

            // æœªåˆ†ç»„é¡¹ä½œä¸ºå•ç‹¬çš„æŠ˜å æ 
            const ungrouped = savedConversations.filter(c => !c.groupId)
                .sort((a, b) => new Date(b.updatedAt || b.timestamp || 0) - new Date(a.updatedAt || a.timestamp || 0));

            const ungroupDetails = document.createElement('details');
            ungroupDetails.className = 'conversation-group';
            const ungroupSummary = document.createElement('summary');
            ungroupSummary.textContent = 'æœªåˆ†ç»„ä¼šè¯';
            ungroupDetails.appendChild(ungroupSummary);
            const ungroupList = document.createElement('div');
            ungroupList.className = 'group-list';

            ungrouped.forEach(conversation => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                const date = new Date(conversation.updatedAt || conversation.timestamp);
                const formattedTime = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                item.innerHTML = `
                        <div class="conversation-info">
                            <h3 class="conversation-name">${conversation.name}<span class="model-badge">${conversation.model || 'æœªè®°å½•'}</span></h3>
                            <p class="conversation-time">${formattedTime}</p>
                        <button class="toggle-summary-btn">æŸ¥çœ‹ä¼šè¯è®°å¿†</button>
                        <div class="conversation-summary-content" style="display:none;">${conversation.summary ? conversation.summary : '<i class="small-muted">è®°å¿†ç”Ÿæˆä¸­æˆ–ä¸å­˜åœ¨</i>'}</div>
                        </div>
                        <div class="conversation-actions">
                        <button class="load-btn" data-id="${conversation.id}"><i class="fas fa-download"></i> åŠ è½½</button>
                        <button class="rename-conv-btn" data-id="${conversation.id}"><i class="fas fa-edit"></i></button>
                        <button class="move-conv-btn" data-id="${conversation.id}"><i class="fas fa-folder-open"></i></button>
                        <button class="delete-conv-btn" data-id="${conversation.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                ungroupList.appendChild(item);

                const toggleBtn = item.querySelector('.toggle-summary-btn');
                const summaryDiv = item.querySelector('.conversation-summary-content');
                if (toggleBtn && summaryDiv) {
                    toggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (summaryDiv.style.display === 'none') {
                            summaryDiv.style.display = 'block';
                            toggleBtn.textContent = 'éšè—ä¼šè¯è®°å¿†';
                        } else {
                            summaryDiv.style.display = 'none';
                            toggleBtn.textContent = 'æŸ¥çœ‹ä¼šè¯è®°å¿†';
                        }
                    });
                }
            });

            ungroupDetails.appendChild(ungroupList);
            conversationsList.appendChild(ungroupDetails);

            // æ·»åŠ äº‹ä»¶å§”æ‰˜ï¼šä½¿ç”¨å®¹å™¨é€‰æ‹©å™¨ä»¥å‡å°‘æŸ¥æ‰¾æ¬¡æ•°
            conversationsList.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const conversationId = e.currentTarget.getAttribute('data-id');
                    loadConversation(conversationId);
                });
            });

            conversationsList.querySelectorAll('.delete-conv-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    try {
                        const conversationId = e.currentTarget.getAttribute('data-id');
                        const confirmed = await showConfirmModal('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ');
                        if (!confirmed) return;
                        deleteConversation(conversationId);
                        renderConversationsList();
                    } catch (err) { console.error('åˆ é™¤ä¼šè¯å¼‚å¸¸ï¼š', err); }
                });
            });

            conversationsList.querySelectorAll('.rename-conv-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    try {
                        const conversationId = e.currentTarget.getAttribute('data-id');
                        const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                        const idx = saved.findIndex(c => c.id === conversationId);
                        const currentName = (idx !== -1 && saved[idx].name) ? saved[idx].name : '';
                        const newName = await showInputModal({ title: 'é‡å‘½åä¼šè¯', label: 'æ–°çš„ä¼šè¯åç§°', value: currentName, placeholder: 'è¾“å…¥æ–°çš„ä¼šè¯åç§°' });
                        if (newName !== null && String(newName).trim() !== '') {
                            if (idx !== -1) {
                                saved[idx].name = String(newName).trim();
                                saved[idx].updatedAt = new Date().toISOString();
                                localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                                renderConversationsList();
                            }
                        }
                    } catch (err) { console.error('ä¼šè¯é‡å‘½åå¼‚å¸¸ï¼š', err); }
                });
            });

            conversationsList.querySelectorAll('.move-conv-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    try {
                        const conversationId = e.currentTarget.getAttribute('data-id');
                        const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                        // æ„å»ºä¸‹æ‹‰é€‰é¡¹ï¼šç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ— åˆ†ç»„
                        const selectOptions = [{ value: '', label: 'æ— åˆ†ç»„' }].concat(groups.map(g => ({ value: g.id, label: g.name })));
                        const choice = await showInputModal({ title: 'ç§»åŠ¨ä¼šè¯åˆ°åˆ†ç»„', label: 'é€‰æ‹©ç›®æ ‡åˆ†ç»„ï¼ˆæˆ–é€‰æ‹©â€œæ— åˆ†ç»„â€ï¼‰', selectOptions: selectOptions, value: '' });
                        if (choice !== null) {
                            let targetGroupId = (choice === '') ? null : String(choice);
                            let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                            const idx = saved.findIndex(c => c.id === conversationId);
                            if (idx !== -1) {
                                saved[idx].groupId = targetGroupId;
                                saved[idx].updatedAt = new Date().toISOString();
                                localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                                renderConversationsList();
                            }
                        }
                    } catch (err) { console.error('ç§»åŠ¨ä¼šè¯å¼‚å¸¸ï¼š', err); }
                });
            });

            // é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†æŒ‰é’®
            conversationsList.querySelectorAll('.regenerate-summary-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    try {
                        const conversationId = e.currentTarget.getAttribute('data-id');
                        const confirmed = await showConfirmModal('ç¡®å®šè¦ä¸ºè¯¥ä¼šè¯é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†å—ï¼Ÿå¯èƒ½äº§ç”ŸAPIè°ƒç”¨è´¹ç”¨ã€‚');
                        if (!confirmed) return;
                        const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                        const conv = saved.find(c => c.id === conversationId);
                        if (!conv) return alert('æœªæ‰¾åˆ°è¯¥ä¼šè¯');
                        // æ‘˜è¦è°ƒç”¨ä½¿ç”¨å…¨å±€ OPENROUTER_API_KEYï¼ˆä¸å†ä¾èµ–ç”¨æˆ·åœ¨è®¾ç½®ä¸­è¾“å…¥ Keyï¼‰
                        const apiKey = window.OPENROUTER_API_KEY || localStorage.getItem('deepseekApiKey');
                        if (!apiKey) return alert('æœªé…ç½®å¯ç”¨çš„ OpenRouter API Key');

                        if (!window.PROMPTS || !window.PROMPTS.SESSION_SUMMARY) {
                            throw new Error('PROMPTS.SESSION_SUMMARY æœªæ‰¾åˆ°ï¼Œæ— æ³•ç”Ÿæˆä¼šè¯è®°å¿†ï¼Œè¯·ç¡®ä¿ prompts.js å·²åŠ è½½ä¸”åŒ…å« SESSION_SUMMARY');
                        }
                        const systemPrompt = window.PROMPTS.SESSION_SUMMARY;
                        const userContent = (conv.messages || conv.content || []).map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n');
                        // è¯¥ä¼šè¯è®°å½•çš„æ¨¡å‹ä¼˜å…ˆï¼›è‹¥æ— åˆ™å›é€€åˆ°å…¨å±€æ¨¡å‹
                        const modelToUse = (conv && conv.model) ? conv.model : (window.MODEL_NAME || 'minimax/minimax-m2:free');
                        // æ—¥å¿—ï¼šå¼€å§‹é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†è¯·æ±‚
                        let _resumEvtId = null;
                        try {
                            _resumEvtId = (window.Logger && window.Logger.start({
                                type: 'summary_request',
                                endpoint: (window.DEEPSEEK_API_URL || 'https://openrouter.ai/api/v1/chat/completions'),
                                model: modelToUse,
                                req: { headersMasked: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ***masked***' }, body: { model: modelToUse, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userContent }], temperature: 0.2 } }
                            })) || null;
                        } catch (_) {}

                        const resp = await fetch(window.DEEPSEEK_API_URL || 'https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: modelToUse, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userContent }], temperature: 0.2 })
                        });
                        try { window.Logger && _resumEvtId && window.Logger.append(_resumEvtId, { res: { status: resp.status } }); } catch (_) {}
                        if (!resp.ok) {
                            try { window.Logger && _resumEvtId && window.Logger.end(_resumEvtId, { error: { message: 'é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†è¯·æ±‚å¤±è´¥' } }); } catch (_) {}
                            throw new Error('APIè¯·æ±‚å¤±è´¥');
                        }
                        const data = await resp.json();
                        try { window.Logger && _resumEvtId && window.Logger.end(_resumEvtId, { type: 'summary_done', res: { final: data } }); } catch (_) {}
                        const summaryText = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : null;
                        if (summaryText) {
                            const idx = saved.findIndex(c => c.id === conversationId);
                            if (idx !== -1) {
                                saved[idx].summary = summaryText;
                                saved[idx].updatedAt = new Date().toISOString();
                                localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                                renderConversationsList();
                            }
                        }
                    } catch (err) {
                        console.error('é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†å¤±è´¥ï¼š', err);
                        alert('é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯');
                    }
                });
            });
        }

        /**
         * æ¸²æŸ“æ–°ç‰ˆä¼šè¯åˆ—è¡¨ï¼ˆå¡ç‰‡ + å¤šé€‰ + åˆ†æ å¸ƒå±€ï¼‰
         */
        function renderConversationsList() {
            const listEl = document.getElementById('conversationsList');
            if (!listEl) return;
            const savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]')
                .sort((a, b) => new Date(b.updatedAt || b.timestamp || 0) - new Date(a.updatedAt || a.timestamp || 0));
            const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
            const existingIds = new Set(savedConversations.map(c => c.id));
            Array.from(selectedConversationIds).forEach(id => {
                if (!existingIds.has(id)) selectedConversationIds.delete(id);
            });
            listEl.innerHTML = '';
            if (!savedConversations.length) {
                if (conversationsEmptyState) conversationsEmptyState.style.display = 'block';
                renderGroupSidebarPanel(groups, new Map());
                updateBulkActions();
                return;
            }
            if (conversationsEmptyState) conversationsEmptyState.style.display = 'none';
            const grouped = new Map();
            groups.forEach(g => grouped.set(g.id, []));
            grouped.set('__ungrouped__', []);
            savedConversations.forEach(conv => {
                const key = (conv.groupId && grouped.has(conv.groupId)) ? conv.groupId : '__ungrouped__';
                grouped.get(key).push(conv);
            });
            const buildGroupSection = (groupMeta, convs) => {
                if (!convs.length && groupMeta) return;
                const section = document.createElement('div');
                section.className = 'group-panel';
                const header = document.createElement('header');
                const info = document.createElement('div');
                info.innerHTML = `<strong>${groupMeta ? groupMeta.name : 'æœªåˆ†ç»„'}</strong><small>${convs.length} ä¸ªä¼šè¯</small>`;
                header.appendChild(info);
                section.appendChild(header);
                if (!convs.length) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    empty.style.padding = '12px';
                    empty.textContent = 'æš‚æ— ä¼šè¯';
                    section.appendChild(empty);
                    return section;
                }
                convs.forEach(conv => section.appendChild(createConversationCard(conv)));
                return section;
            };
            groups.forEach(group => {
                const block = buildGroupSection(group, grouped.get(group.id) || []);
                if (block) listEl.appendChild(block);
            });
            const ungroupBlock = buildGroupSection(null, grouped.get('__ungrouped__') || []);
            if (ungroupBlock) listEl.appendChild(ungroupBlock);
            renderGroupSidebarPanel(groups, grouped);
            updateBulkActions();
        }

        function createConversationCard(conversation) {
            const card = document.createElement('div');
            card.className = 'conversation-card';
            card.dataset.id = conversation.id;
            if (selectedConversationIds.has(conversation.id)) card.classList.add('active');

            const topRow = document.createElement('div');
            topRow.className = 'card-top';
            const title = document.createElement('h3');
            title.textContent = conversation.name || 'æœªå‘½åä¼šè¯';
            topRow.appendChild(title);
            if (multiSelectMode) {
                const selectBox = document.createElement('label');
                selectBox.className = 'pill';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedConversationIds.has(conversation.id);
                checkbox.addEventListener('change', (e) => {
                    handleSelectionChange(conversation.id, e.target.checked);
                    card.classList.toggle('active', e.target.checked);
                });
                selectBox.appendChild(checkbox);
                selectBox.appendChild(document.createTextNode('é€‰æ‹©'));
                topRow.appendChild(selectBox);
            }
            card.appendChild(topRow);

            const meta = document.createElement('div');
            meta.className = 'card-meta';
            meta.innerHTML = `
                <span><i class="fas fa-robot"></i>${conversation.model || 'æœªè®°å½•'}</span>
                <span><i class="fas fa-clock"></i>${formatTimestamp(conversation.updatedAt || conversation.timestamp)}</span>
                <span><i class="fas fa-comments"></i>${(conversation.messages || []).length} æ¡æ¶ˆæ¯</span>
            `;
            card.appendChild(meta);

            const summaryToggle = document.createElement('button');
            summaryToggle.className = 'view-memory-btn';
            summaryToggle.textContent = 'å±•å¼€è®°å¿†';
            const summaryBody = document.createElement('div');
            summaryBody.className = 'conversation-summary-content';
            summaryBody.style.display = 'none';
            summaryBody.textContent = summarizeText(conversation.summary || 'è®°å¿†ç”Ÿæˆä¸­æˆ–å°šæœªç”Ÿæˆã€‚', 220);
            summaryToggle.addEventListener('click', () => {
                const expanded = summaryBody.style.display === 'block';
                summaryBody.style.display = expanded ? 'none' : 'block';
                summaryToggle.textContent = expanded ? 'å±•å¼€è®°å¿†' : 'éšè—è®°å¿†';
            });
            card.appendChild(summaryToggle);
            card.appendChild(summaryBody);

            const actions = document.createElement('div');
            actions.className = 'card-actions';
            const actionConfigs = [
                { label: 'åŠ è½½', handler: () => loadConversation(conversation.id) },
                { label: 'é‡å‘½å', handler: () => renameConversation(conversation.id) },
                { label: 'ç§»åŠ¨', handler: () => moveConversation(conversation.id) },
                { label: 'é‡æ–°æ‘˜è¦', handler: () => regenerateConversationSummary(conversation.id) },
                { label: 'åˆ é™¤', handler: () => deleteConversationWithConfirm(conversation.id) },
            ];
            actionConfigs.forEach(cfg => {
                const btn = document.createElement('button');
                btn.textContent = cfg.label;
                btn.addEventListener('click', cfg.handler);
                actions.appendChild(btn);
            });
            card.appendChild(actions);
            return card;
        }

        function formatTimestamp(ts) {
            if (!ts) return 'æœªçŸ¥æ—¶é—´';
            try {
                const date = new Date(ts);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
            } catch (_) {
                return 'æœªçŸ¥æ—¶é—´';
            }
        }

        function summarizeText(text, limit = 160) {
            const trimmed = String(text || '').replace(/\s+/g, ' ').trim();
            if (!trimmed) return 'æš‚æ— å†…å®¹';
            return trimmed.length > limit ? `${trimmed.slice(0, limit)}...` : trimmed;
        }

        function renderGroupSidebarPanel(groups, groupedMap = new Map()) {
            if (!groupListPanel) return;
            groupListPanel.innerHTML = '';
            if (!groups.length) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.style.padding = '16px';
                empty.textContent = 'å°šæœªåˆ›å»ºåˆ†ç»„';
                groupListPanel.appendChild(empty);
                return;
            }
            groups.forEach(group => {
                const panel = document.createElement('div');
                panel.className = 'group-panel';
                const header = document.createElement('header');
                const info = document.createElement('div');
                const convCount = (groupedMap.get(group.id) || []).length;
                info.innerHTML = `<strong>${group.name}</strong><small>${convCount} ä¸ªä¼šè¯</small>`;
                header.appendChild(info);
                const btnBox = document.createElement('div');
                const renameBtn = document.createElement('button');
                renameBtn.className = 'group-rename-btn';
                renameBtn.innerHTML = '<i class="fas fa-edit"></i>';
                renameBtn.title = 'é‡å‘½å';
                renameBtn.addEventListener('click', () => renameGroup(group));
                const regenBtn = document.createElement('button');
                regenBtn.className = 'group-regen-btn';
                regenBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                regenBtn.title = 'é‡æ–°ç”Ÿæˆè®°å¿†';
                regenBtn.addEventListener('click', async () => {
                    const confirmed = await showConfirmModal('ç¡®å®šè¦ä¸ºè¯¥åˆ†ç»„é‡æ–°ç”Ÿæˆè®°å¿†å—ï¼Ÿ');
                    if (!confirmed) return;
                    await updateGroupMemory(group.id);
                    renderConversationsList();
                });
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'group-delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'åˆ é™¤åˆ†ç»„';
                deleteBtn.addEventListener('click', () => deleteGroupAndMove(group));
                btnBox.appendChild(renameBtn);
                btnBox.appendChild(regenBtn);
                btnBox.appendChild(deleteBtn);
                header.appendChild(btnBox);
                panel.appendChild(header);
                const summary = document.createElement('div');
                summary.className = 'conversation-summary-content';
                summary.textContent = group.memorySummary ? summarizeText(group.memorySummary, 200) : 'æš‚æ— åˆ†ç»„è®°å¿†';
                panel.appendChild(summary);
                groupListPanel.appendChild(panel);
            });
        }

        async function renameGroup(group) {
            try {
                const newName = await showInputModal({ title: 'é‡å‘½ååˆ†ç»„', label: 'æ–°çš„åˆ†ç»„åç§°', value: group.name, placeholder: 'è¾“å…¥æ–°çš„åˆ†ç»„åç§°' });
                if (newName === null) return;
                const trimmed = String(newName).trim();
                if (!trimmed) return;
                const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                const idx = groups.findIndex(g => g.id === group.id);
                if (idx !== -1) {
                    groups[idx].name = trimmed;
                    groups[idx].updatedAt = new Date().toISOString();
                    localStorage.setItem('conversationGroups', JSON.stringify(groups));
                    renderConversationsList();
                }
            } catch (err) {
                console.error('é‡å‘½ååˆ†ç»„å¤±è´¥ï¼š', err);
            }
        }

        async function deleteGroupAndMove(group) {
            const confirmed = await showConfirmModal('åˆ é™¤åˆ†ç»„å°†æŠŠè¯¥åˆ†ç»„ä¸‹çš„ä¼šè¯ç§»åŠ¨åˆ°æœªåˆ†ç»„ï¼Œç¡®å®šåˆ é™¤ï¼Ÿ');
            if (!confirmed) return;
            let groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
            groups = groups.filter(g => g.id !== group.id);
            localStorage.setItem('conversationGroups', JSON.stringify(groups));
            let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            saved = saved.map(c => c.groupId === group.id ? Object.assign({}, c, { groupId: null, updatedAt: new Date().toISOString() }) : c);
            localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
            renderConversationsList();
        }

        async function renameConversation(conversationId) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                const idx = saved.findIndex(c => c.id === conversationId);
                if (idx === -1) return;
                const currentName = saved[idx].name || '';
                const newName = await showInputModal({ title: 'é‡å‘½åä¼šè¯', label: 'æ–°çš„ä¼šè¯åç§°', value: currentName, placeholder: 'è¾“å…¥æ–°çš„ä¼šè¯åç§°' });
                if (newName === null) return;
                const trimmed = String(newName).trim();
                if (!trimmed) return;
                saved[idx].name = trimmed;
                saved[idx].updatedAt = new Date().toISOString();
                localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                renderConversationsList();
            } catch (err) {
                console.error('é‡å‘½åä¼šè¯å¤±è´¥ï¼š', err);
            }
        }

        async function moveConversation(conversationId) {
            await moveConversations([conversationId]);
        }

        async function moveConversations(conversationIds) {
            if (!conversationIds.length) return;
            const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
            const selectOptions = [{ value: '', label: 'æ— åˆ†ç»„' }].concat(groups.map(g => ({ value: g.id, label: g.name })));
            const choice = await showInputModal({ title: 'é€‰æ‹©ç›®æ ‡åˆ†ç»„', label: 'å¯é€‰æ‹©â€œæ— åˆ†ç»„â€', selectOptions, value: '' });
            if (choice === null) return;
            const targetId = choice === '' ? null : choice;
            let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            let changed = false;
            saved = saved.map(conv => {
                if (!conversationIds.includes(conv.id)) return conv;
                changed = true;
                return Object.assign({}, conv, { groupId: targetId, updatedAt: new Date().toISOString() });
            });
            if (changed) {
                localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                selectedConversationIds.clear();
                renderConversationsList();
            }
        }

        async function deleteConversationWithConfirm(conversationId) {
            const confirmed = await showConfirmModal('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ');
            if (!confirmed) return;
            deleteConversation(conversationId);
            selectedConversationIds.delete(conversationId);
            renderConversationsList();
        }

        async function handleBulkDelete() {
            if (!selectedConversationIds.size) return;
            const confirmed = await showConfirmModal(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedConversationIds.size} ä¸ªä¼šè¯å—ï¼Ÿ`);
            if (!confirmed) return;
            selectedConversationIds.forEach(id => deleteConversation(id));
            selectedConversationIds.clear();
            renderConversationsList();
        }

        async function handleBulkMove() {
            if (!selectedConversationIds.size) return;
            await moveConversations(Array.from(selectedConversationIds));
            selectedConversationIds.clear();
        }

        function handleBulkExport() {
            if (!selectedConversationIds.size) return;
            const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            const selected = saved.filter(c => selectedConversationIds.has(c.id));
            downloadText(`freechat-selected-${Date.now()}.json`, JSON.stringify(selected, null, 2));
        }

        function exportAllConversations() {
            const saved = localStorage.getItem('savedDeepseekConversations') || '[]';
            downloadText(`freechat-conversations-${Date.now()}.json`, saved);
        }

        function downloadText(fileName, text) {
            try {
                const blob = new Blob([text], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('å¯¼å‡ºå¤±è´¥ï¼š', err);
            }
        }

        async function regenerateConversationSummary(conversationId) {
            const confirmed = await showConfirmModal('ç¡®å®šè¦ä¸ºè¯¥ä¼šè¯é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†å—ï¼Ÿå¯èƒ½äº§ç”ŸAPIè°ƒç”¨è´¹ç”¨ã€‚');
            if (!confirmed) return;
            const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            const conv = saved.find(c => c.id === conversationId);
            if (!conv) return alert('æœªæ‰¾åˆ°è¯¥ä¼šè¯');
            const apiKey = window.OPENROUTER_API_KEY || localStorage.getItem('deepseekApiKey');
            if (!apiKey) return alert('æœªé…ç½®å¯ç”¨çš„ OpenRouter API Key');
            if (!window.PROMPTS || !window.PROMPTS.SESSION_SUMMARY) {
                alert('ç¼ºå°‘ SESSION_SUMMARY æ¨¡æ¿ï¼Œæ— æ³•ç”Ÿæˆè®°å¿†');
                return;
            }
            const systemPrompt = window.PROMPTS.SESSION_SUMMARY;
            const userContent = (conv.messages || conv.content || []).map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n');
            const modelToUse = conv.model || window.MODEL_NAME || 'minimax/minimax-m2:free';
            let evtId = null;
            try {
                evtId = (window.Logger && window.Logger.start({
                    type: 'summary_request',
                    endpoint: (window.DEEPSEEK_API_URL || 'https://openrouter.ai/api/v1/chat/completions'),
                    model: modelToUse
                })) || null;
            } catch (_) {}
            try {
                const resp = await fetch(window.DEEPSEEK_API_URL || 'https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: modelToUse, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userContent }], temperature: 0.2 })
                });
                try { window.Logger && evtId && window.Logger.append(evtId, { res: { status: resp.status } }); } catch (_) {}
                if (!resp.ok) throw new Error('API è¯·æ±‚å¤±è´¥');
                const data = await resp.json();
                const summaryText = data?.choices?.[0]?.message?.content || '';
                const idx = saved.findIndex(c => c.id === conversationId);
                if (idx !== -1 && summaryText) {
                    saved[idx].summary = summaryText;
                    saved[idx].updatedAt = new Date().toISOString();
                    localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                    renderConversationsList();
                }
                try { window.Logger && evtId && window.Logger.end(evtId, { type: 'summary_done' }); } catch (_) {}
            } catch (err) {
                console.error('é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†å¤±è´¥ï¼š', err);
                alert('é‡æ–°ç”Ÿæˆä¼šè¯è®°å¿†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—');
                try { window.Logger && evtId && window.Logger.end(evtId, { error: { message: err.message } }); } catch (_) {}
            }
        }

        /**
         * æ›´æ–°åˆ†ç»„è®°å¿†
         * åŠŸèƒ½ï¼šèšåˆæŒ‡å®šåˆ†ç»„ä¸‹æ‰€æœ‰ä¼šè¯çš„è®°å¿†ï¼Œè°ƒç”¨APIç”Ÿæˆåˆ†ç»„è®°å¿†å¹¶ä¿å­˜
         * å‚æ•°ï¼šgroupId - åˆ†ç»„ID
         * è¿”å›å€¼ï¼šPromiseï¼Œæ— è¿”å›å€¼
         */
        async function updateGroupMemory(groupId) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                const groupConvs = saved.filter(c => c.groupId === groupId && c.summary).map(c => c.summary);
                if (groupConvs.length === 0) return;

                const apiKey = (window.OPENROUTER_API_KEY || localStorage.getItem('deepseekApiKey'));
                if (!apiKey) return;

                if (!window.PROMPTS || !window.PROMPTS.GROUP_SUMMARY) {
                    throw new Error('PROMPTS.GROUP_SUMMARY æœªæ‰¾åˆ°ï¼Œæ— æ³•ç”Ÿæˆåˆ†ç»„è®°å¿†ï¼Œè¯·ç¡®ä¿ prompts.js å·²åŠ è½½ä¸”åŒ…å« GROUP_SUMMARY');
                }
                const systemPrompt = window.PROMPTS.GROUP_SUMMARY;

                const modelToUse = window.MODEL_NAME || 'minimax/minimax-m2:free';
                // æ—¥å¿—ï¼šå¼€å§‹åˆ†ç»„è®°å¿†è¯·æ±‚
                let _gmEvtId = null;
                try {
                    _gmEvtId = (window.Logger && window.Logger.start({
                        type: 'groupmem_request',
                        endpoint: (window.DEEPSEEK_API_URL || 'https://openrouter.ai/api/v1/chat/completions'),
                        model: modelToUse,
                        req: { headersMasked: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ***masked***' }, body: { model: modelToUse, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: groupConvs.join('\n\n') }], temperature: 0.2 } }
                    })) || null;
                } catch (_) {}

                const resp = await fetch(window.DEEPSEEK_API_URL || 'https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({ model: modelToUse, messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: groupConvs.join('\n\n') }], temperature: 0.2 })
                });
                try { window.Logger && _gmEvtId && window.Logger.append(_gmEvtId, { res: { status: resp.status } }); } catch (_) {}
                if (!resp.ok) { try { window.Logger && _gmEvtId && window.Logger.end(_gmEvtId, { error: { message: 'åˆ†ç»„è®°å¿†è¯·æ±‚å¤±è´¥' } }); } catch (_) {} return; }
                const data = await resp.json();
                const memoryText = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : null;
                try { window.Logger && _gmEvtId && window.Logger.end(_gmEvtId, { type: 'groupmem_done', res: { final: data } }); } catch (_) {}
                if (memoryText) {
                    let groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                    const idx = groups.findIndex(g => g.id === groupId);
                    if (idx !== -1) {
                        groups[idx].memorySummary = memoryText;
                        groups[idx].updatedAt = new Date().toISOString();
                        localStorage.setItem('conversationGroups', JSON.stringify(groups));
                        // æ›´æ–°ç•Œé¢ä»¥æ˜¾ç¤ºæ–°çš„åˆ†ç»„è®°å¿†
                        try { renderConversationsList(); } catch (e) { console.error('renderConversationsList è°ƒç”¨å¤±è´¥ï¼š', e); }
                    }
                }
            } catch (err) {
                console.error('æ›´æ–°åˆ†ç»„è®°å¿†å¤±è´¥ï¼š', err);
            }
        }

        /**
         * åŠ è½½ä¼šè¯
         * åŠŸèƒ½ï¼šæ ¹æ®ä¼šè¯IDåŠ è½½ä¼šè¯æ•°æ®åˆ°localStorageï¼Œå¹¶è·³è½¬åˆ°ä¸»èŠå¤©é¡µé¢
         * å‚æ•°ï¼šconversationId - ä¼šè¯ID
         * è¿”å›å€¼ï¼šæ— 
         */
        function loadConversation(conversationId) {
            const savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            const conversation = savedConversations.find(c => c.id === conversationId);

            if (conversation) {
                const payload = conversation.messages || conversation.content || [];
                localStorage.setItem('deepseekConversation', JSON.stringify(payload));
                // è®°å½•å½“å‰ä¼šè¯æ‰€å±åˆ†ç»„ï¼Œä»¥ä¾¿ index é¡µé¢æ³¨å…¥åˆ†ç»„è®°å¿†
                if (conversation.groupId) localStorage.setItem('deepseekConversationGroupId', conversation.groupId);
                else localStorage.removeItem('deepseekConversationGroupId');
                // è®°å½•å½“å‰å·²ä¿å­˜ä¼šè¯çš„IDï¼Œä¾› index é¡µé¢åœ¨å‘é€/æ¥æ”¶æ—¶æ›´æ–°å¯¹åº”ä¼šè¯
                localStorage.setItem('deepseekConversationId', conversation.id);
                // å¦‚æœä¼šè¯è®°å½•äº†ä½¿ç”¨çš„æ¨¡å‹ï¼Œåˆ™æ¢å¤åˆ° chatModelï¼Œä¿è¯åŠ è½½ä¼šè¯æ—¶æ¨¡å‹ä¸€è‡´
                if (conversation.model) {
                    try { localStorage.setItem('chatModel', conversation.model); } catch (e) { /* å¿½ç•¥å¼‚å¸¸é¿å…æ‰“æ–­æµç¨‹ */ }
                }
                window.location.href = 'index.html';
            }
        }

        /**
         * åˆ é™¤ä¼šè¯
         * åŠŸèƒ½ï¼šä»localStorageä¸­åˆ é™¤æŒ‡å®šIDçš„ä¼šè¯
         * å‚æ•°ï¼šconversationId - è¦åˆ é™¤çš„ä¼šè¯ID
         * è¿”å›å€¼ï¼šæ— 
         */
        function deleteConversation(conversationId) {
            let savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            savedConversations = savedConversations.filter(c => c.id !== conversationId);
            localStorage.setItem('savedDeepseekConversations', JSON.stringify(savedConversations));
        }
    </script>
</body>
</html>
