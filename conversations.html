<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼šè¯ç®¡ç† - DeepSeek å¯¹è¯</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="prompts.js"></script>
</head>
<body>
    <header class="header">
        <button id="backBtn" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h1>ä¼šè¯ç®¡ç†</h1>
        <button id="newChatBtn" class="new-chat-btn">
            <i class="fas fa-plus"></i>
        </button>
    </header>

    <main class="conversations-container">
        <div id="conversationsList" class="conversations-list"></div>
        <div class="group-controls">
            <input id="newGroupName" placeholder="æ–°åˆ†ç»„å" />
            <button id="createGroupBtn">åˆ›å»ºåˆ†ç»„</button>
        </div>
        <button id="saveCurrentBtn" class="save-current-btn">ä¿å­˜å½“å‰ä¼šè¯</button>
    </main>

    <script>
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ‰€æœ‰ä¿å­˜çš„ä¼šè¯
        document.addEventListener('DOMContentLoaded', () => {
            renderConversationsList();

            // è¿”å›æŒ‰é’®äº‹ä»¶
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // æ–°å»ºä¼šè¯æŒ‰é’®
            document.getElementById('newChatBtn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦å¼€å§‹æ–°ä¼šè¯å—ï¼Ÿå½“å‰ä¼šè¯ä¼šè¢«ä¿å­˜ã€‚')) {
                    saveCurrentConversation('æ–°ä¼šè¯');
                    // æ¸…é™¤ä¸´æ—¶ä¼šè¯ä¸åˆ†ç»„å…³è”
                    localStorage.setItem('deepseekConversation', JSON.stringify([]));
                    localStorage.removeItem('deepseekConversationGroupId');
                    window.location.href = 'index.html';
                }
            });

            // ä¿å­˜å½“å‰ä¼šè¯æŒ‰é’®
            document.getElementById('saveCurrentBtn').addEventListener('click', () => {
                const currentConversation = localStorage.getItem('deepseekConversation');
                if (currentConversation && JSON.parse(currentConversation).length > 0) {
                    const name = prompt('è¯·è¾“å…¥ä¼šè¯åç§°ï¼š', 'æ–°ä¼šè¯');
                    if (name) {
                        saveCurrentConversation(name);
                        renderConversationsList();
                    }
                } else {
                    alert('å½“å‰æ²¡æœ‰å¯ä¿å­˜çš„ä¼šè¯å†…å®¹');
                }
            });

            // åˆ›å»ºåˆ†ç»„æŒ‰é’®
            document.getElementById('createGroupBtn').addEventListener('click', () => {
                const nameInput = document.getElementById('newGroupName');
                const name = nameInput.value && nameInput.value.trim();
                if (!name) { alert('è¯·è¾“å…¥åˆ†ç»„åç§°'); return; }
                const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                const id = Date.now().toString();
                groups.push({ id, name, memorySummary: null, updatedAt: new Date().toISOString() });
                localStorage.setItem('conversationGroups', JSON.stringify(groups));
                nameInput.value = '';
                renderConversationsList();
            });
        });

            // ä¿å­˜å½“å‰ä¼šè¯ï¼ˆå¢å¼ºï¼šæ·»åŠ  summary ä¸ groupId æ”¯æŒï¼‰
        async function saveCurrentConversation(name) {
            const currentConversation = localStorage.getItem('deepseekConversation');
            if (!currentConversation) return;

                let savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');

                // ç”Ÿæˆå”¯ä¸€ID
                const conversationId = Date.now().toString();

            const conversationObj = {
                    id: conversationId,
                    name: name,
                messages: JSON.parse(currentConversation),
                summary: null,
                groupId: localStorage.getItem('deepseekConversationGroupId') || null,
                updatedAt: new Date().toISOString()
            };

            // å…ˆä¿å­˜ä¼šè¯ä¸»ä½“
            savedConversations.push(conversationObj);
            localStorage.setItem('savedDeepseekConversations', JSON.stringify(savedConversations));

            // å¼‚æ­¥è°ƒç”¨ DeepSeek ç”Ÿæˆä¼šè¯æ‘˜è¦å¹¶ä¿å­˜ï¼ˆå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼‰
            try {
                const apiKey = localStorage.getItem('deepseekApiKey');
                    if (apiKey) {
                    // ä½¿ç”¨æ›´æ˜ç¡®çš„æ‘˜è¦æç¤ºè¯ï¼Œè®©æ¨¡å‹ä»¥è¦ç‚¹å½¢å¼è¿”å›æ‘˜è¦
                    if (!window.PROMPTS || !window.PROMPTS.SESSION_SUMMARY) {
                        throw new Error('PROMPTS.SESSION_SUMMARY æœªæ‰¾åˆ°ï¼Œæ— æ³•ç”Ÿæˆä¼šè¯æ‘˜è¦ï¼Œè¯·ç¡®ä¿ prompts.js å·²åŠ è½½ä¸”åŒ…å« SESSION_SUMMARY');
                    }
                    const systemPrompt = window.PROMPTS.SESSION_SUMMARY;

                    // ä½¿ç”¨å·²ä¿å­˜çš„å®Œæ•´æ¶ˆæ¯æ•°ç»„ä½œä¸ºæ‘˜è¦è¾“å…¥ï¼Œé˜²æ­¢åªæäº¤æœ€è¿‘ä¸€æ¡æ¶ˆæ¯
                    let savedForSummary = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                    const savedIdxForThis = savedForSummary.findIndex(c => c.id === conversationId);
                    const messagesForSummary = (savedIdxForThis !== -1 && savedForSummary[savedIdxForThis].messages && savedForSummary[savedIdxForThis].messages.length > 0)
                        ? savedForSummary[savedIdxForThis].messages
                        : conversationObj.messages;
                    console.log('ç”Ÿæˆä¼šè¯æ‘˜è¦ï¼Œæ¶ˆæ¯æ¡æ•°ï¼š', messagesForSummary.length);
                    const userContent = messagesForSummary.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n');

                    const resp = await fetch(window.DEEPSEEK_API_URL || 'https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({ model: 'deepseek-chat', messages: [ { role: 'system', content: systemPrompt }, { role: 'user', content: userContent } ], temperature: 0.2 })
                    });

                    if (resp.ok) {
                        const data = await resp.json();
                        const summaryText = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : null;
                        if (summaryText) {
                            // æ›´æ–°å¯¹åº”ä¼šè¯çš„ summary å­—æ®µ
                            let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                            const idx = saved.findIndex(c => c.id === conversationId);
                            if (idx !== -1) {
                                saved[idx].summary = summaryText;
                                saved[idx].updatedAt = new Date().toISOString();
                                localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                            }

                            // å¦‚æœå±äºåˆ†ç»„ï¼Œåˆ™è§¦å‘åˆ†ç»„è®°å¿†èšåˆæ›´æ–°
                            if (conversationObj.groupId) {
                                await updateGroupMemory(conversationObj.groupId);
                            }
                        }
                    }
                }
            } catch (err) {
                console.error('ç”Ÿæˆä¼šè¯æ‘˜è¦å¤±è´¥ï¼š', err);
            }
        }

        // æ¸²æŸ“ä¼šè¯åˆ—è¡¨ä¸ºæŠ˜å æ ‘å½¢ç»“æ„ï¼ˆæ–‡ä»¶å¤¹å½¢å¼ï¼‰
        function renderConversationsList() {
            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = '';

            const savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');

            if (savedConversations.length === 0 && groups.length === 0) {
                conversationsList.innerHTML = '<div class="no-conversations">æš‚æ— ä¿å­˜çš„ä¼šè¯</div>';
                return;
            }

            // ä¸ºæ¯ä¸ªåˆ†ç»„åˆ›å»ºä¸€ä¸ªæŠ˜å çš„ details å…ƒç´ 
            groups.forEach(group => {
                const groupDetails = document.createElement('details');
                groupDetails.className = 'conversation-group';

                const summary = document.createElement('summary');
                summary.innerHTML = `${group.name} <small class="group-meta">${group.memorySummary ? '(æœ‰åˆ†ç»„è®°å¿†)' : ''}</small>`;
                // æ·»åŠ é‡å‘½åä¸åˆ é™¤æŒ‰é’®åˆ°åˆ†ç»„æ ‡é¢˜
                const renameBtn = document.createElement('button');
                renameBtn.className = 'group-rename-btn';
                renameBtn.innerHTML = '<i class="fas fa-edit"></i>';
                renameBtn.title = 'é‡å‘½ååˆ†ç»„';
                renameBtn.style.marginLeft = '8px';
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newName = prompt('è¾“å…¥æ–°çš„åˆ†ç»„åç§°ï¼š', group.name);
                    if (newName) {
                        let groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                        const idx = groups.findIndex(g => g.id === group.id);
                        if (idx !== -1) {
                            groups[idx].name = newName;
                            groups[idx].updatedAt = new Date().toISOString();
                            localStorage.setItem('conversationGroups', JSON.stringify(groups));
                            renderConversationsList();
                        }
                    }
                });

                const delBtn = document.createElement('button');
                delBtn.className = 'group-delete-btn';
                delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                delBtn.title = 'åˆ é™¤åˆ†ç»„';
                delBtn.style.marginLeft = '8px';
                delBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!confirm('åˆ é™¤åˆ†ç»„å°†æŠŠè¯¥åˆ†ç»„ä¸‹çš„ä¼šè¯ç§»åŠ¨åˆ°æœªåˆ†ç»„ï¼Œç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                    let groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                    groups = groups.filter(g => g.id !== group.id);
                    localStorage.setItem('conversationGroups', JSON.stringify(groups));
                    // å°†è¯¥ç»„å†…ä¼šè¯ç§»åŠ¨åˆ°æœªåˆ†ç»„
                    let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                    saved = saved.map(c => c.groupId === group.id ? Object.assign({}, c, { groupId: null, updatedAt: new Date().toISOString() }) : c);
                    localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                    renderConversationsList();
                });

                // åˆ†ç»„è®°å¿†æ˜¾ç¤ºåŒºï¼ˆé»˜è®¤éšè—ï¼‰ï¼Œæä¾›æŸ¥çœ‹åˆ†ç»„è®°å¿†åŠŸèƒ½
                const memoryDiv = document.createElement('div');
                memoryDiv.className = 'group-memory';
                memoryDiv.style.display = 'none';
                memoryDiv.style.padding = '8px 12px';
                memoryDiv.style.borderLeft = '2px solid #eee';
                memoryDiv.style.marginBottom = '8px';
                memoryDiv.innerHTML = group.memorySummary ? `<strong>åˆ†ç»„è®°å¿†ï¼š</strong><div>${group.memorySummary}</div>` : '<i class="small-muted">æš‚æ— åˆ†ç»„è®°å¿†</i>';

                const viewMemoryBtn = document.createElement('button');
                viewMemoryBtn.className = 'view-memory-btn';
                viewMemoryBtn.textContent = group.memorySummary ? 'æŸ¥çœ‹åˆ†ç»„è®°å¿†' : 'æš‚æ— åˆ†ç»„è®°å¿†';
                viewMemoryBtn.style.marginLeft = '8px';
                viewMemoryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (memoryDiv.style.display === 'none') {
                        memoryDiv.style.display = 'block';
                        viewMemoryBtn.textContent = 'éšè—åˆ†ç»„è®°å¿†';
                    } else {
                        memoryDiv.style.display = 'none';
                        viewMemoryBtn.textContent = group.memorySummary ? 'æŸ¥çœ‹åˆ†ç»„è®°å¿†' : 'æš‚æ— åˆ†ç»„è®°å¿†';
                    }
                });
                // å°†æŸ¥çœ‹æŒ‰é’®æ·»åŠ åˆ° summaryï¼ˆåœ¨ä¹‹å appendï¼‰

                summary.appendChild(renameBtn);
                summary.appendChild(delBtn);
                summary.appendChild(viewMemoryBtn);
                // åˆ†ç»„é‡æ–°æ‘˜è¦æŒ‰é’®
                const regenGroupBtn = document.createElement('button');
                regenGroupBtn.className = 'group-regen-btn';
                regenGroupBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                regenGroupBtn.title = 'é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†';
                regenGroupBtn.style.marginLeft = '8px';
                regenGroupBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (!confirm('ç¡®å®šè¦ä¸ºè¯¥åˆ†ç»„é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†å—ï¼Ÿå¯èƒ½äº§ç”ŸAPIè°ƒç”¨è´¹ç”¨ã€‚')) return;
                    try {
                        await updateGroupMemory(group.id);
                        // updateGroupMemory å†…ä¼šä¿å­˜ memorySummary
                        renderConversationsList();
                        alert('åˆ†ç»„è®°å¿†å·²æ›´æ–°');
                    } catch (err) {
                        console.error('é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†å¤±è´¥ï¼š', err);
                        alert('é‡æ–°ç”Ÿæˆåˆ†ç»„è®°å¿†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
                    }
                });
                summary.appendChild(regenGroupBtn);
                groupDetails.appendChild(summary);
                // åœ¨ summary åæ’å…¥åˆ†ç»„è®°å¿†å±•ç¤ºåŒº
                groupDetails.appendChild(memoryDiv);

                const list = document.createElement('div');
                list.className = 'group-list';

                // åç»­ä¼šåˆ›å»º memoryDiv å’Œ viewMemoryBtnï¼Œé¿å…é‡å¤å£°æ˜

                const groupConvs = savedConversations.filter(c => c.groupId === group.id)
                    .sort((a, b) => new Date(b.updatedAt || b.timestamp || 0) - new Date(a.updatedAt || a.timestamp || 0));

                groupConvs.forEach(conversation => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item';
                    const date = new Date(conversation.updatedAt || conversation.timestamp);
                    const formattedTime = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    item.innerHTML = `
                        <div class="conversation-info">
                            <h3 class="conversation-name">${conversation.name}</h3>
                            <p class="conversation-time">${formattedTime}</p>
                            <button class="toggle-summary-btn">æŸ¥çœ‹ä¼šè¯æ‘˜è¦</button>
                            <div class="conversation-summary-content" style="display:none; margin-top:6px;">${conversation.summary ? conversation.summary : '<i class="small-muted">æ‘˜è¦ç”Ÿæˆä¸­æˆ–ä¸å­˜åœ¨</i>'}</div>
                        </div>
                        <div class="conversation-actions">
                            <button class="load-btn" data-id="${conversation.id}"><i class="fas fa-download"></i> åŠ è½½</button>
                            <button class="regenerate-summary-btn" data-id="${conversation.id}" title="é‡æ–°ç”Ÿæˆä¼šè¯æ‘˜è¦">ğŸ”</button>
                            <button class="rename-conv-btn" data-id="${conversation.id}"><i class="fas fa-edit"></i></button>
                            <button class="move-conv-btn" data-id="${conversation.id}"><i class="fas fa-folder-open"></i></button>
                            <button class="delete-conv-btn" data-id="${conversation.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(item);

                    // ç»‘å®šæ‘˜è¦æ˜¾ç¤ºåˆ‡æ¢
                    const toggleBtn = item.querySelector('.toggle-summary-btn');
                    const summaryDiv = item.querySelector('.conversation-summary-content');
                    if (toggleBtn && summaryDiv) {
                        toggleBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (summaryDiv.style.display === 'none') {
                                summaryDiv.style.display = 'block';
                                toggleBtn.textContent = 'éšè—ä¼šè¯æ‘˜è¦';
                            } else {
                                summaryDiv.style.display = 'none';
                                toggleBtn.textContent = 'æŸ¥çœ‹ä¼šè¯æ‘˜è¦';
                            }
                        });
                    }
                });

                groupDetails.appendChild(list);
                conversationsList.appendChild(groupDetails);
            });

            // æœªåˆ†ç»„é¡¹ä½œä¸ºå•ç‹¬çš„æŠ˜å æ 
            const ungrouped = savedConversations.filter(c => !c.groupId)
                .sort((a, b) => new Date(b.updatedAt || b.timestamp || 0) - new Date(a.updatedAt || a.timestamp || 0));

            const ungroupDetails = document.createElement('details');
            ungroupDetails.className = 'conversation-group';
            const ungroupSummary = document.createElement('summary');
            ungroupSummary.textContent = 'æœªåˆ†ç»„ä¼šè¯';
            ungroupDetails.appendChild(ungroupSummary);
            const ungroupList = document.createElement('div');
            ungroupList.className = 'group-list';

            ungrouped.forEach(conversation => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                const date = new Date(conversation.updatedAt || conversation.timestamp);
                const formattedTime = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                item.innerHTML = `
                        <div class="conversation-info">
                            <h3 class="conversation-name">${conversation.name}</h3>
                            <p class="conversation-time">${formattedTime}</p>
                        <button class="toggle-summary-btn">æŸ¥çœ‹ä¼šè¯æ‘˜è¦</button>
                        <div class="conversation-summary-content" style="display:none; margin-top:6px;">${conversation.summary ? conversation.summary : '<i class="small-muted">æ‘˜è¦ç”Ÿæˆä¸­æˆ–ä¸å­˜åœ¨</i>'}</div>
                        </div>
                        <div class="conversation-actions">
                        <button class="load-btn" data-id="${conversation.id}"><i class="fas fa-download"></i> åŠ è½½</button>
                        <button class="rename-conv-btn" data-id="${conversation.id}"><i class="fas fa-edit"></i></button>
                        <button class="move-conv-btn" data-id="${conversation.id}"><i class="fas fa-folder-open"></i></button>
                        <button class="delete-conv-btn" data-id="${conversation.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                ungroupList.appendChild(item);

                const toggleBtn = item.querySelector('.toggle-summary-btn');
                const summaryDiv = item.querySelector('.conversation-summary-content');
                if (toggleBtn && summaryDiv) {
                    toggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (summaryDiv.style.display === 'none') {
                            summaryDiv.style.display = 'block';
                            toggleBtn.textContent = 'éšè—ä¼šè¯æ‘˜è¦';
                        } else {
                            summaryDiv.style.display = 'none';
                            toggleBtn.textContent = 'æŸ¥çœ‹ä¼šè¯æ‘˜è¦';
                        }
                    });
                }
            });

            ungroupDetails.appendChild(ungroupList);
            conversationsList.appendChild(ungroupDetails);

            // æ·»åŠ äº‹ä»¶å§”æ‰˜ï¼šä½¿ç”¨å®¹å™¨é€‰æ‹©å™¨ä»¥å‡å°‘æŸ¥æ‰¾æ¬¡æ•°
            conversationsList.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const conversationId = e.currentTarget.getAttribute('data-id');
                    loadConversation(conversationId);
                });
            });

            conversationsList.querySelectorAll('.delete-conv-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const conversationId = e.currentTarget.getAttribute('data-id');
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) {
                        deleteConversation(conversationId);
                        renderConversationsList();
                    }
                });
            });

            conversationsList.querySelectorAll('.rename-conv-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const conversationId = e.currentTarget.getAttribute('data-id');
                    const newName = prompt('è¾“å…¥æ–°çš„ä¼šè¯åç§°ï¼š');
                    if (newName) {
                        let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                        const idx = saved.findIndex(c => c.id === conversationId);
                        if (idx !== -1) {
                            saved[idx].name = newName;
                            saved[idx].updatedAt = new Date().toISOString();
                            localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                            renderConversationsList();
                        }
                    }
                });
            });

            conversationsList.querySelectorAll('.move-conv-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const conversationId = e.currentTarget.getAttribute('data-id');
                    const groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                    const groupOptions = ['æ— åˆ†ç»„'].concat(groups.map(g => g.name));
                    const choice = prompt(`è¾“å…¥ç›®æ ‡åˆ†ç»„åç§°ï¼ˆå¯é€‰ï¼‰ï¼š\n${groupOptions.join('\n')}`);
                    if (choice !== null) {
                        let targetGroupId = null;
                        if (choice !== '' && choice !== 'æ— åˆ†ç»„') {
                            const g = groups.find(x => x.name === choice);
                            if (g) targetGroupId = g.id;
                            else alert('æœªæ‰¾åˆ°è¯¥åˆ†ç»„åç§°');
                        }

                        let saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                        const idx = saved.findIndex(c => c.id === conversationId);
                        if (idx !== -1) {
                            saved[idx].groupId = targetGroupId;
                            saved[idx].updatedAt = new Date().toISOString();
                            localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                            renderConversationsList();
                        }
                    }
                });
            });

            // é‡æ–°æ‘˜è¦ä¼šè¯æŒ‰é’®
            conversationsList.querySelectorAll('.regenerate-summary-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const conversationId = e.currentTarget.getAttribute('data-id');
                    if (!confirm('ç¡®å®šè¦ä¸ºè¯¥ä¼šè¯é‡æ–°ç”Ÿæˆæ‘˜è¦å—ï¼Ÿå¯èƒ½äº§ç”ŸAPIè°ƒç”¨è´¹ç”¨ã€‚')) return;
                    try {
                        const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                        const conv = saved.find(c => c.id === conversationId);
                        if (!conv) return alert('æœªæ‰¾åˆ°è¯¥ä¼šè¯');
                        const apiKey = localStorage.getItem('deepseekApiKey');
                        if (!apiKey) return alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Key');

                        if (!window.PROMPTS || !window.PROMPTS.SESSION_SUMMARY) {
                            throw new Error('PROMPTS.SESSION_SUMMARY æœªæ‰¾åˆ°ï¼Œæ— æ³•ç”Ÿæˆä¼šè¯æ‘˜è¦ï¼Œè¯·ç¡®ä¿ prompts.js å·²åŠ è½½ä¸”åŒ…å« SESSION_SUMMARY');
                        }
                        const systemPrompt = window.PROMPTS.SESSION_SUMMARY;
                        const userContent = (conv.messages || conv.content || []).map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n');
                        const resp = await fetch(window.DEEPSEEK_API_URL || 'https://api.deepseek.com/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: userContent }], temperature: 0.2 })
                        });
                        if (!resp.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
                        const data = await resp.json();
                        const summaryText = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : null;
                        if (summaryText) {
                            const idx = saved.findIndex(c => c.id === conversationId);
                            if (idx !== -1) {
                                saved[idx].summary = summaryText;
                                saved[idx].updatedAt = new Date().toISOString();
                                localStorage.setItem('savedDeepseekConversations', JSON.stringify(saved));
                                renderConversationsList();
                            }
                        }
                    } catch (err) {
                        console.error('é‡æ–°ç”Ÿæˆæ‘˜è¦å¤±è´¥ï¼š', err);
                        alert('é‡æ–°ç”Ÿæˆæ‘˜è¦å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯');
                    }
                });
            });
        }

        // æ›´æ–°åˆ†ç»„è®°å¿†ï¼ˆèšåˆè¯¥åˆ†ç»„ä¸‹æ‰€æœ‰ä¼šè¯çš„ summary å¹¶å‘DeepSeekè¯·æ±‚äºŒæ¬¡æ‘˜è¦ï¼‰
        async function updateGroupMemory(groupId) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
                const groupConvs = saved.filter(c => c.groupId === groupId && c.summary).map(c => c.summary);
                if (groupConvs.length === 0) return;

                const apiKey = localStorage.getItem('deepseekApiKey');
                if (!apiKey) return;

                if (!window.PROMPTS || !window.PROMPTS.GROUP_SUMMARY) {
                    throw new Error('PROMPTS.GROUP_SUMMARY æœªæ‰¾åˆ°ï¼Œæ— æ³•ç”Ÿæˆåˆ†ç»„è®°å¿†ï¼Œè¯·ç¡®ä¿ prompts.js å·²åŠ è½½ä¸”åŒ…å« GROUP_SUMMARY');
                }
                const systemPrompt = window.PROMPTS.GROUP_SUMMARY;

                const resp = await fetch(window.DEEPSEEK_API_URL || 'https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: groupConvs.join('\n\n') }], temperature: 0.2 })
                });

                if (!resp.ok) return;
                const data = await resp.json();
                const memoryText = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : null;
                if (memoryText) {
                    let groups = JSON.parse(localStorage.getItem('conversationGroups') || '[]');
                    const idx = groups.findIndex(g => g.id === groupId);
                    if (idx !== -1) {
                        groups[idx].memorySummary = memoryText;
                        groups[idx].updatedAt = new Date().toISOString();
                        localStorage.setItem('conversationGroups', JSON.stringify(groups));
                        // æ›´æ–°ç•Œé¢ä»¥æ˜¾ç¤ºæ–°çš„åˆ†ç»„è®°å¿†
                        try { renderConversationsList(); } catch (e) { console.error('renderConversationsList è°ƒç”¨å¤±è´¥ï¼š', e); }
                    }
                }
            } catch (err) {
                console.error('æ›´æ–°åˆ†ç»„è®°å¿†å¤±è´¥ï¼š', err);
            }
        }

        // åŠ è½½ä¼šè¯ï¼ˆå…¼å®¹æ—§å­—æ®µ content ä¸æ–°å­—æ®µ messagesï¼‰
        function loadConversation(conversationId) {
            const savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            const conversation = savedConversations.find(c => c.id === conversationId);

            if (conversation) {
                const payload = conversation.messages || conversation.content || [];
                localStorage.setItem('deepseekConversation', JSON.stringify(payload));
                // è®°å½•å½“å‰ä¼šè¯æ‰€å±åˆ†ç»„ï¼Œä»¥ä¾¿ index é¡µé¢æ³¨å…¥åˆ†ç»„è®°å¿†
                if (conversation.groupId) localStorage.setItem('deepseekConversationGroupId', conversation.groupId);
                else localStorage.removeItem('deepseekConversationGroupId');
                // è®°å½•å½“å‰å·²ä¿å­˜ä¼šè¯çš„IDï¼Œä¾› index é¡µé¢åœ¨å‘é€/æ¥æ”¶æ—¶æ›´æ–°å¯¹åº”ä¼šè¯
                localStorage.setItem('deepseekConversationId', conversation.id);
                window.location.href = 'index.html';
            }
        }

        // åˆ é™¤ä¼šè¯
        function deleteConversation(conversationId) {
            let savedConversations = JSON.parse(localStorage.getItem('savedDeepseekConversations') || '[]');
            savedConversations = savedConversations.filter(c => c.id !== conversationId);
            localStorage.setItem('savedDeepseekConversations', JSON.stringify(savedConversations));
        }
    </script>
</body>
</html>
