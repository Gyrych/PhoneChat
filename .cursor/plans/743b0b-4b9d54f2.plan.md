<!-- 4b9d54f2-5c2a-4185-8936-6bbdcdb91b51 799340a1-bacf-4ece-9799-179e84d08ce9 -->
# 修复会话加载竞态与无响应

**目标**：修复两个用户报告的问题：

- 会话完成后再次加载会话出现加载无响应／重新点击加载后新会话内容被清空；
- 历史会话加载在某些情况下不响应（不渲染或未恢复会话内容）。

**高层思路**：

1. 先在代码中定位相关实现点（`index.html` 与 `conversations.html`，以及 `dist/` 的产物），重点查找：会话加载函数（如 `loadConversation` / `loadSavedConversation`）、会话保存/节流逻辑（`batchedStorageSetJson` / 节流 1.5s）、流式解析与写回逻辑（`updateLastAssistantMessage`、`saveConversation`）、以及 `memoryJobs`、`window._sendingInProgress` / `AbortController` 等全局状态的使用。
2. 复现并确认失败场景：加载时是否存在并发写入覆盖（节流回写延迟/合并导致覆盖空会话）、加载未取消正在进行的流导致 UI 状态阻塞、或 load 路径在遇到 sendLock/abort 时不刷新 UI。
3. 修复策略（逐项可回退）：1

- 在加载会话前：主动中止当前正在进行的生成（若存在）并等待批量写入队列 flush（对 `batchedStorageSetJson` 增加 `flush()` 接口或短暂等待），避免正在写回的持久化覆盖加载的数据；
- 在保存/写回时：使用会话对象上的 `lastModified` / `updatedAt` 时间戳来做写回原子检查（写入前比较目标条目上的 `updatedAt`，仅在当前快照比存储旧时才写回）；
- 避免空会话覆盖：在加载新会话后，不要立即触发将空会话写回到持久存储；保存逻辑应跳过“空会话首次持久化”或在创建会话时明确区分“临时会话/持久会话”状态；
- UI 刷新：确保 `loadConversation` 在完成数据切换后调用 `renderMessages()` 并强制刷新模型徽章/标题栏与滚动；若使用懒加载的 markdown 库，确保在渲染后可见。
- 历史会话加载不响应：修复抽屉/会话管理里绑定的点击处理函数，消除因 `event.preventDefault()` / 锁变量导致的 early return；对异步处理加超时并在失败时给出错误提示。

4. 修改范围：优先修改 `index.html`、`conversations.html`（若存在）和 `dist/index.html`、`dist/conversations.html` 中的对应产物；必要时修改 `script.js`（公共 helper，如 `batchedStorageSetJson`、`showConfirmModal`）、并在 `CURSOR.md` 与 README（中/英）同步记录修改要点。

**关键文件（将检查与修改）**：

- `index.html`
- `conversations.html`
- `dist/index.html`、`dist/conversations.html`
- `script.js`（公共 helper）
- `prompts.js`（仅查阅）

**实施步骤与验收**：

1. 阅读并定位相关函数实现（静态审查）。
2. 在本地以 Chrome 手工复现问题；记录最小复现步骤与控制台错误。 
3. 实现修复（分小 PR/编辑）：添加 AbortController 中止、增加 `batchedStorageSetJson.flush()` 或在加载前等待合并写入、在写入时用 `updatedAt` 做乐观并发检查、修正加载函数中的 UI 强制刷新。 
4. 在修改后确认：能正常加载历史会话、重复点击加载不会清空当前新会话内容、抽屉加载响应可靠。 
5. 更新 `CURSOR.md` 的“变更记录”段与 README（中/英）中“会话持久化/加载”说明（只要实现与文档不同就同步）。

**风险与回退**：

- 修改会影响 `dist/` 打包产物，需要同时更新 `dist/` 中的对应文件或重新运行构建；我会把修改控制在可回退的小范围并保留注释说明（中文）。

---

实现性任务（用于跟踪，后续执行时会作为 todo）：

- id: locate_load_logic
content: 定位并阅读 `loadConversation`/`loadSavedConversation` 与保存节流的实现
- id: reproduce_and_log
content: 在 Chrome 上复现问题并记录控制台错误与最小复现步骤
dependencies: [locate_load_logic]
- id: implement_abort_and_flush
content: 在 `index.html` 中加载会话前中止当前请求并等待 `batchedStorageSetJson` 的 flush
dependencies: [locate_load_logic, reproduce_and_log]
- id: implement_optimistic_write_check
content: 为会话写回加入 `updatedAt` 比较以避免会话覆盖
dependencies: [implement_abort_and_flush]
- id: fix_ui_refresh_and_drawer_handlers
content: 确保 `loadConversation` 在成功后强制刷新 UI 并修复抽屉加载事件的早期返回
dependencies: [implement_optimistic_write_check]
- id: docs_update_cursor_readme
content: 更新 `CURSOR.md` 与 `README.md`/`README_zh.md` 的会话加载修复记录与说明
dependencies: [fix_ui_refresh_and_drawer_handlers]

请确认此计划（我将随后开始按计划执行代码定位并提出具体代码修改），或指出你希望调整的实现策略（例如：是否接受在 `index.html` 引入 `AbortController` 并改变写回行为）。