<!-- 652f3b58-6c66-4238-8de3-20f5cc691fad 394705cf-367e-4f8d-9953-464cdd6b4736 -->
# 添加用户自定义 system 提示词与可调大模型参数（config 页面 + 会话持久化）

目标：在 `config.html` 中新增全局设置项：

- **全局 System 提示词**（可选，字符串，localStorage 键：`freechat.systemPrompt`）
- **模型参数**（temperature、top_p、max_tokens、stream），以 JSON 存储（localStorage 键：`freechat.modelParams`）

运行时行为：

- 构造请求时若存在会话级 `conversation.modelParams` 则优先使用；否则使用 `freechat.modelParams`；若均不存在使用内置默认（temperature=0.7, top_p=0.9, max_tokens=1024, stream=true）。
- 若 `freechat.systemPrompt` 非空，则在请求消息列表最前插入一条 system 消息（类型：system），若会话也含有覆盖的 systemPrompt 则会话级优先。
- 新建或首次保存持久会话时，将当前“有效模型参数”拷贝到该会话对象的 `modelParams` 字段，保证历史会话重现当时参数。

要修改的文件（主要）：

- `config.html`：新增 UI 控件（textarea + 参数输入 + 开关），及保存逻辑写入 `localStorage.freechat.*`。
- `index.html`：实现读取/合并参数的辅助函数（`getGlobalModelParams()`、`getConversationModelParams(conv)`、`getEffectiveModelParams(conv)`、`getEffectiveSystemPrompt(conv)`），在发送请求时注入 system prompt 并将参数合并到请求体中；在创建/保存会话时保存 `modelParams` 到会话对象。
- `conversations.html`：在加载会话时恢复会话级 `modelParams` 到运行时上下文（保证加载后发送使用该参数）；在保存/导出会话时包含 `modelParams` 字段。
- 文档：`CURSOR.md`、`README.md`、`README_zh.md`：添加/更新配置说明与本次变更记录。

关键实现片段（示例，需在实际文件中按项目风格集成）：

配置页新增控件（示例）：

```html
<!-- config.html 的一段新增表单 -->
<label>全局 System 提示（可选）</label>
<textarea id="globalSystemPrompt" rows="4" placeholder="可留空，不注入"></textarea>

<label>Temperature</label>
<input id="paramTemperature" type="number" step="0.01" min="0" max="2" />
<label>Top P</label>
<input id="paramTopP" type="number" step="0.01" min="0" max="1" />
<label>Max Tokens</label>
<input id="paramMaxTokens" type="number" step="1" min="1" />
<label>Stream</label>
<input id="paramStream" type="checkbox" />
<button id="saveConfigBtn">保存设置</button>
```

保存逻辑示例：

```javascript
document.getElementById('saveConfigBtn').addEventListener('click', () => {
  localStorage.setItem('freechat.systemPrompt', document.getElementById('globalSystemPrompt').value || '');
  const params = {
    temperature: parseFloat(document.getElementById('paramTemperature').value) || 0.7,
    top_p: parseFloat(document.getElementById('paramTopP').value) || 0.9,
    max_tokens: parseInt(document.getElementById('paramMaxTokens').value, 10) || 1024,
    stream: !!document.getElementById('paramStream').checked
  };
  localStorage.setItem('freechat.modelParams', JSON.stringify(params));
  // 显示已保存提示
});
```

请求构造处（index.html）：

```javascript
function getGlobalModelParams() {
  try {
    return JSON.parse(localStorage.getItem('freechat.modelParams') || 'null') || { temperature:0.7, top_p:0.9, max_tokens:1024, stream:true };
  } catch (e) { return { temperature:0.7, top_p:0.9, max_tokens:1024, stream:true }; }
}

function getConversationModelParams(conv) {
  return conv && conv.modelParams ? conv.modelParams : null;
}

function getEffectiveModelParams(conv) {
  return Object.assign({}, getGlobalModelParams(), getConversationModelParams(conv) || {});
}

function getEffectiveSystemPrompt(conv) {
  return (conv && conv.systemPrompt) || localStorage.getItem('freechat.systemPrompt') || '';
}

// 在构造请求 body 时
const systemPrompt = getEffectiveSystemPrompt(currentConversation);
const effectiveParams = getEffectiveModelParams(currentConversation);
const requestBody = {
  model: getCurrentModel(),
  messages: [ ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []), ...builtMessages ],
  temperature: effectiveParams.temperature,
  top_p: effectiveParams.top_p,
  max_tokens: effectiveParams.max_tokens,
  // 其余字段按远端 API 期望命名
};
```

会话持久化（新建/保存会话时）：

```javascript
// 在会话首次持久化时
savedDeepseekConversations[idx].modelParams = getEffectiveModelParams(currentConversation);
// 可选：保存会话级 systemPrompt
savedDeepseekConversations[idx].systemPrompt = getEffectiveSystemPrompt(currentConversation) || '';
upsertSavedConversationNow(savedDeepseekConversations[idx]);
```

验证步骤（手工）：

- 打开 `config.html`，设置 System 提示与参数，点击保存→ 检查 `localStorage.freechat.systemPrompt` 与 `localStorage.freechat.modelParams`。
- 在主界面新建会话并发送消息→ 在浏览器网络面板检查请求体是否包含参数并在 messages 首条存在 system 消息（若设置）。
- 新建会话后刷新/重新加载 → 发送消息应使用会话保存的参数（打开抽屉查看会话 modelParams 字段，或在开发者工具查看 localStorage）。

注意/兼容性：

- 默认 behavior：System 提示为空时不注入。会话级覆盖优先于全局。会话保存时会复制当时的有效参数以便回溯。
- 我会保持对现有 `localStorage.chatModel`、`window.MODEL_NAME` 的兼容性，不改动现有模型选择逻辑，仅在请求体中添加/合并额外参数。
- 修改后需同步更新 `CURSOR.md` 与 `README`（中/英）以记录新增配置键与行为。

实现增量与验收：

1. 在 `config.html` 增 UI 并保存到 localStorage（手动验证）
2. 在 `index.html` 加载并应用配置（单次修改，验证发送请求）
3. 在 `conversations.html` 恢复/保存会话级 params（验证加载历史会话）
4. 文档更新：`CURSOR.md`、`README.md`、`README_zh.md` 更新说明与变更记录

如果你确认该方案，我将开始按计划实施并依次提交实现编辑。

### To-dos

- [x] 在 `config.html` 添加全局 System 提示词与模型参数输入并保存到 localStorage
- [x] 在 `index.html` 实现读取/合并模型参数与 system prompt 的辅助函数并在发送请求时使用
- [x] 在会话创建/保存流程中将当前有效模型参数与 system prompt 拷贝到会话对象并持久化
- [x] 在 `conversations.html` 和抽屉加载逻辑中恢复会话级 modelParams 以保证发送时生效
- [x] 更新 `CURSOR.md`、`README.md`、`README_zh.md` 以记录新增配置键、行为与示例