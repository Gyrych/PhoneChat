<!-- 8c677e65-cb4c-4e4d-ad22-21fb565667a7 f28a048d-bb52-420f-b59f-a6dab4655421 -->
# 异步记忆任务：引入后台任务队列并展示状态

概述：在不阻塞聊天主流程的前提下，把自动/手动会话记忆生成改为入队异步执行，使用（或复用）内联 Blob Worker 作为后台工作器来执行网络请求与文本处理。任务状态（pending / in-progress /done /failed）持久化到 localStorage（新增 `memoryJobs` 或在 `savedDeepseekConversations` 增加 `memoryJob` 字段），并在 UI 提供独立面板展示与重试操作。

受影响关键文件：

- `index.html`：发送流程、`autoSummarizeIfNeeded()`、`upsertSavedConversationNow()`、流结束钩子（enqueue）
- `conversations.html`：手动生成记忆与分组记忆刷新（触发队列任务）
- `prompts.js`：记忆/摘要提示词（复用，无大量改动）
- `CURSOR.md` / `README.md` / `README_zh.md`：将修改记录与使用说明同步

实施要点（简洁）：

1. 新增记忆任务模块（`memoryQueue`）

- 提供 `enqueueMemoryJob(conversationId, type)`、`startWorker()`、`recoverPendingJobs()`、`updateJobStatus()` 等接口
- 使用 `localStorage` 键 `memoryJobs`（数组）持久化任务队列，避免浏览器刷新丢失
- 使用内联 Blob Worker 执行生成请求（复用现有 `window._streamParserWorker` 逻辑或新 Worker）

2. 修改流结束处行为（`index.html`）

- 在流结束后先调用 `upsertSavedConversationNow()` 强制写回会话内容
- 不再 `await autoSummarizeIfNeeded()`；改为 `enqueueMemoryJob(conversationId, 'session')`（立即返回）

3. 任务执行与写回策略

- Worker 执行生成后，主线程原子更新对应会话的 `summary`、`lastSummarizedMessageCount` 与 `updatedAt`（通过读-改-写 localStorage）
- 成功/失败结果写回 `memoryJobs`（状态），失败支持有限次数自动重试并在最终失败时保留重试入口供用户手动重试

4. UI 展示与操作（聊天/会话列表）

- 在会话列表/聊天界面新增“记忆生成状态”区域，显示当前会话/分组的任务状态与进度（pending/in-progress/done/failed），提供“重试/查看/忽略”按钮
- 若任务正在进行，展示明显提示（例如“记忆生成中（后台）”），不阻塞发送/接收交互

5. 修复丢失/竞态问题

- 确保 enqueue 前 `upsertSavedConversationNow()` 执行完成（等待本地写回），以保证生成时使用最新会话内容
- 在 Worker 返回后，重复核对会话 message count（避免覆盖更晚写入的摘要），仅在 `lastSummarizedMessageCount` 仍然小于生成时的 count 时写回

6. 文档与 CURSOR.md 更新

- 在 `CURSOR.md` 主体中记录架构变更（memoryQueue 设计与键名），末尾追加变更记录
- 同步更新 `README.md` / `README_zh.md` 使用说明与配置项（localStorage 开关、重试次数、并发限制等）

配置与回退：

- 使用 localStorage 配置项（例 `freechat.memory.queueConcurrency`、`freechat.memory.retryMax`）以便调优
- 回退策略：如需回退，只需恢复 `autoSummarizeIfNeeded()` 原始 await 行为并移除 `memoryJobs` 相关代码

风险与测试要点：

- 风险：Worker 与主线程的 localStorage 同步写入可能引起短暂竞态，需在写回前后读取校验
- 测试点：刷新页面后 pending 任务能自动恢复并继续执行；任务失败后的重试逻辑正确；会话结束后不会阻塞 UI

实现 TODO（可直接执行）：

### To-dos

- [ ] 实现记忆任务队列模块
- [ ] 在流结束处改为入队而非 await 生成
- [ ] 新增记忆任务UI与状态展示
- [ ] 更新 CURSOR.md 与 README 文档