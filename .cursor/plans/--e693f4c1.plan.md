<!-- e693f4c1-a5eb-4a59-88de-3d132a870ead df504b47-d893-4692-a874-5a71085618e9 -->
# 实现计划：会话实时保存、摘要与分组记忆

## 概要

基于现有 `index.html` / `conversations.html` 的静态前端架构，使用 `localStorage` 做持久化，使用用户提供的 DeepSeek API 生成会话摘要与分组记忆。实现包含：实时保存、历史会话加载/重命名、分组创建/重命名/移动/删除、生成并展示会话摘要与分组记忆、并在同组会话时把分组记忆作为系统提示词发送给 DeepSeek API。

## 主要改动文件（预期）

- `index.html` — 在发送/接收流程中注入：实时保存会话、读取当前分组记忆并作为系统提示词。\
- `conversations.html` — 新增/改进：会话列表、重命名、移动到分组、查看会话摘要、查看分组记忆。\
- `script.js` — 增加本地持久化、分组管理与 DeepSeek 摘要调用的辅助方法（或新建 `storage.js` / `deepseek.js`，视代码结构而定）。\
- `CURSOR.md`、`README.md`、`README_zh.md` — 根据实现同步更新主体说明与使用说明（README 不记录变更日志，仅功能/结构/依赖/使用方式）。

## 数据模型（localStorage）

```javascript
// 保存会话数组
localStorage.savedDeepseekConversations = JSON.stringify([
  {
    id: 'conv-uuid',
    title: '会话标题',
    messages: [{ role: 'user'|'assistant'|'system', content: '...', timestamp: 1670000000000 }],
    summary: '摘要文本', // DeepSeek 返回的会话摘要
    groupId: 'group-uuid' | null,
    updatedAt: 1670000000000
  },
  // ...
]);

// 保存分组列表
localStorage.conversationGroups = JSON.stringify([
  { id: 'group-uuid', name: '分组名', memorySummary: '分组记忆摘要', updatedAt: 1670000000000 }
]);
```

## 关键实现点（按步骤）

1. 设计并实现本地数据模型与读取/写入工具函数（封装 JSON parse/stringify、防并发写入基础）。
2. 在消息发送/接收点实现“实时保存”：每次用户发言或收到 AI 回复后更新对应 `currentConversation` 并写入 `savedDeepseekConversations`（若未保存则作为临时会话）。
3. 在用户保存会话时调用 DeepSeek API 生成会话摘要（summary），保存到对应会话对象；若该会话属于某个分组，则触发“分组记忆聚合”步骤。示例调用（伪代码）：
```javascript
const resp = await fetch(DEEPSEEK_API_URL, {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${deepseekApiKey}`, 'Content-Type': 'application/json' },
  body: JSON.stringify({ messages: conversation.messages, task: 'summarize' })
});
const { summary } = await resp.json();
```

4. 分组记忆聚合：当分组内任一会话被保存/更新后，收集该分组下所有会话的 `summary` 字段，调用 DeepSeek 做二次摘要，结果写入 `conversationGroups[].memorySummary`。
5. 会话/分组 UI：在 `conversations.html` 提供操作（重命名、移动、删除、查看摘要、查看分组记忆），交互更新本地数据并及时保存。
6. 在同一分组内发起新的会话时，读取该分组的 `memorySummary` 并作为 system 提示词附加到发送到 DeepSeek 的请求中，形成“分组记忆注入”。
7. 文档更新：实现完成后更新 `CURSOR.md`（主体内容与追加变更记录）以及 `README.md` / `README_zh.md`（功能概述、项目结构图 mermaid、使用说明、依赖）。

## 性能与边界条件

- localStorage 有容量限制（通常 5MB），若会话过多或消息体过大需提示用户或裁剪旧会话摘要。\
- DeepSeek 调用应做失败重试与降级：若摘要失败，标注会话为“摘要失败”，但仍保存会话内容。

## 安全与隐私提醒

- API Key 仍存于 `localStorage`（与你当前实现一致），提示用户风险并建议使用后端代理以提升安全性（在 README 中说明）。

## 验收条件（可测试项）

- 新发送的消息能实时写入 localStorage。\
- 用户能保存并在历史列表看到会话摘要。\
- 可创建/重命名/删除分组并将会话移动分组。\
- 分组记忆在分组内会话发送时被附加为 system 提示词。\
- `CURSOR.md` 与两个 README 文件同步更新。

### To-dos

- [ ] 设计 localStorage 数据模型与读写工具
- [ ] 实现实时会话保存与摘要触发点
- [ ] 实现会话分组管理界面与会话移动重命名
- [ ] 调用 DeepSeek 生成会话摘要与分组聚合摘要
- [ ] 在同分组会话中注入分组记忆为系统提示词
- [ ] 更新 `CURSOR.md` 与 README 文档（中英文）