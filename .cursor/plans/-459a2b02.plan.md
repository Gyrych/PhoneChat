<!-- 459a2b02-452b-4ff4-8e2f-dd5b11a9c681 a2f4f14e-8194-4034-af3d-c692e0c049df -->
# 在侧边栏新建会话时选择模型并在历史会话中显示模型名

## 概述

- 目标：当用户在主页面抽屉（侧边栏）点击“新建会话”时，弹出“新建会话”模态或内联控件，允许选择模型（来自设置页的模型列表或回退到全局已选模型）；新会话持久化时记录 `model` 字段；抽屉中的会话列表项同时显示该会话对应的模型名；抽屉搜索支持按模型名搜索。
- 设计原则：最小入侵、复用已有逻辑、保持向后兼容。

## 涉及文件（将要修改）

- `index.html` —— 抽屉内新增/修改模态 DOM、处理新建会话的事件、渲染会话项时显示模型、搜索过滤逻辑。  
- `conversations.html` —— （若需保持管理页行为一致）保持或同步模态逻辑（可选，同步更新）。
- `style.css` / `dist/style.css` —— 新增/调整 `.model-badge`、抽屉内模态样式。  
- `CURSOR.md` / `README.md` / `README_zh.md` —— 文档同步说明（更新主体与变更记录）。

## 关键实现点与代码片段（要点，实施时直接插入或替换）

1. 模型来源和优先级：

   - 优先使用用户在抽屉新建时选择的模型（临时存储键 `deepseekNewConversationModel`）。
   - 若未选择，回退到 `localStorage.chatModel`（设置页保存的当前模型）。
   - 若两者均无，回退到 `window.MODEL_NAME` 或项目默认 `'minimax/minimax-m2:free'`。

2. 新建会话时保存模型（示例改动，插入到现有创建会话逻辑处）：
```javascript
// 获取用户在模态中选择的模型，若无则读取全局设置
const selectedModel = (localStorage.getItem('deepseekNewConversationModel') || localStorage.getItem('chatModel') || window.MODEL_NAME || 'minimax/minimax-m2:free');
const newEntry = {
  id: newId,
  name: entryName,
  messages: [],
  summary: null,
  groupId: target.id,
  model: selectedModel,
  updatedAt: new Date().toISOString(),
  lastSummarizedMessageCount: 0
};
```

3. 抽屉内“新建会话”控件（DOM 建议，放在 `#drawer` 或单独模态）：
```html
<!-- 简洁示例：在 drawer-header 下方加入 -->
<div id="drawerNewChatPanel" style="display:none;">
  <input id="newChatNameInput" placeholder="会话名称（可选）" />
  <select id="drawerModelSelect"></select> <!-- 将由 JS 填充；可显示本地缓存/设置页模型列表 -->
  <button id="drawerCreateConfirmBtn">创建并切换</button>
  <button id="drawerCreateCancelBtn">取消</button>
</div>
```


- JS 交互要点：打开抽屉点击“新建会话”时显示该面板或模态；`drawerModelSelect` 用本地缓存的模型列表填充（见下一点）。

4. 模型列表获取策略（尽量复用 `config.html` 的数据源）：

   - 优先从 `localStorage` 中读取由 `config.html` 缓存的模型列表（实现时读取相同的缓存键，若该键不存在则回退到内置静态列表或仅显示当前 `localStorage.chatModel`）。
   - 如果没有中心缓存，可直接在 `index.html` 中使用一份轻量的默认模型选项以保证功能可靠。

5. 抽屉会话项显示模型名（渲染函数修改要点）：

   - 在每个会话条目标题旁渲染一个 `.model-badge`，显示会话 `item.model` 的短形式（可用 CSS 截断）。
   - 示例（渲染逻辑中加入）：
```html
<span class="conversation-name">{{name}}</span>
<span class="model-badge">{{modelShort}}</span>
```


6. 搜索扩展（drawerSearch）：

   - 将现有会话过滤函数从仅匹配会话名/分组改为同时匹配 `item.name || ''`、`groupName`、`(item.model || '')`。
   - 例如：
```javascript
const q = query.trim().toLowerCase();
const match = (itm) => {
  return (itm.name||'').toLowerCase().includes(q)
      || (itm.groupName||'').toLowerCase().includes(q)
      || (itm.model||'').toLowerCase().includes(q);
}
```


7. 清理临时选择：

   - 创建完成后移除 `deepseekNewConversationModel` 与 `deepseekNewConversationName`（若使用）。

8. 文档与 CURSOR.md 更新（必须）：

   - 在 `CURSOR.md` 主体中记录实现方式与新增本地存储键（`deepseekNewConversationModel`），并在变更记录末尾追加条目。  
   - 更新 `README.md` / `README_zh.md` 的“会话管理/抽屉”与“模型配置”部分，说明侧边栏可选模型行为。

## 风险与兼容性注意

- 若 `config.html` 的模型缓存键名不同，需要在实现前确认该键名（我将在实现前读取 `config.html` 确认并复用）。
- 抽屉为最小侵入方案，保留 `conversations.html` 的现有管理页实现；如要同步该页需要额外小修改（计划中包含同步更新）。
- UI 样式需要微调以适配窄屏与长模型名（计划会加 `.model-badge` 的 CSS）。

## 验收标准

- 在主页面抽屉点击“新建会话”可选择模型并创建空会话（立即出现在抽屉列表并可切换）。
- 新会话在 `savedDeepseekConversations` 中的 `model` 字段正确保存。  
- 抽屉历史会话项显示模型徽章/名称。  
- 抽屉搜索能按模型名匹配会话。

## 后续（可选）

- 在 `config.html` 与抽屉间建立更强同步（例如把模型列表缓存键名标准化并在设置页变更时向 `localStorage` 发送事件通知）。

---

我已经把实现拆成以下可追踪的任务（todos），实施时我会逐项完成并在每步后更新状态并修改 `CURSOR.md` 与 README：

### To-dos

- [x] 在 `index.html` 抽屉新增新建会话模态并实现模型下拉数据填充
- [x] 修改新建会话创建逻辑，保存所选模型到 `savedDeepseekConversations[].model`
- [x] 在抽屉会话列表渲染中显示模型徽章并扩展搜索以匹配模型名
- [x] 更新 `CURSOR.md` 与 `README.md` / `README_zh.md` 同步记录实现与新增存储键