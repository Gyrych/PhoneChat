<!-- 504ad965-d9f3-43e1-892c-817c5daf4590 005a7335-61c5-40cf-b237-46de1ecc7e22 -->
# 优化计划：对话、联网检索与记忆的 UX 与运行效率提升

目标：在兼顾延迟、成本与记忆一致性的前提下，系统性改进前端与大模型交互的可用性与性能，产出可审阅的实施步骤与代码改动点（你已选择仅需计划，不直接修改代码）。

关键改进方向（简洁说明）：

- 流式中止与并发控制：引入 AbortController、发送按钮互斥、请求节流/去重。文件：`index.html`。
- 网络健壮性与成本控制：统一重试/退避策略、超时、并限制联网检索频次与结果数量。文件：`index.html`、`config.html`。
- 记忆体系改进：加强会话/分组记忆去噪、合并规则、注入顺序与多 system 兼容（保留单条合并回退）。文件：`prompts.js`、`index.html`、`conversations.html`。
- 联网检索整合与引用处理：标准化插件请求、解析 `delta.annotations` 与尾包 `message.annotations`，并清晰在 UI 展示来源。文件：`index.html`、`prompts.js`。
- 存储与持久化优化：减少 `localStorage` 高频写入，采用写入节流、批量写或迁移到 IndexedDB（建议）。文件：`index.html`、`script.js`。
- 渲染与前端性能：批量 DOM 更新、避免每个流式片段都触发完全渲染、virtualize 长会话列表。文件：`index.html`、`style.css`。
- 资源加载优化：延迟加载 `marked`/`DOMPurify`/`CryptoJS`、按需加载模型徽章与图标，减小首屏开销。文件：`index.html`、`dist/`。
- 日志与隐私：保持环形缓冲设计，但遮蔽敏感头部，提供导出/清空控制与范围选择。文件：`logger.js`、`index.html`。
- 文档同步：确保 `README.md`、`README_zh.md` 与 `CURSOR.md` 与实现一致；更新变更记录。文件：`README.md`、`README_zh.md`、`CURSOR.md`。

建议交付物：

- 一份具体的 PR 列表（每项说明修改文件/行、代码片段与变更理由）
- 性能/体验回归测试清单（手工验证步骤）
- 更新后的 `CURSOR.md` & README（变更记录）

具体实施任务（可逐项实现）：

1. audit-codebase：审计关键路径并记录基准（延迟/写次数/流式速率）。
2. add-abortcontroller：为流式 SSE/fetch 添加 AbortController 支持并实现停止真正中止。
3. send-button-lock：实现发送期间按钮互斥与防抖，阻止并发发送。
4. retry-backoff：新增统一网络重试与指数退避策略（可配置最大重试/超时）。
5. memory-filtering：收紧记忆生成规则并实现语义去重/合并策略（按 CURSOR.md 规则）。
6. memory-injection-order：实现可配置注入顺序与多 system 合并回退逻辑。
7. web-search-throttle：限制联网检索触发频率并在 UI 明示成本/计费估算。
8. citations-rendering：统一解析 `delta.annotations` 与尾包引用并在消息下方展示引用列表。
9. storage-batching：实现 localStorage 写入节流/批量写，评估并建议迁移到 IndexedDB。
10. dom-batching：将流式增量渲染改为批量更新（requestAnimationFrame 或微任务合并）。
11. lazy-load-libs：实现按需加载 `marked`/`DOMPurify`/`CryptoJS`，减少初始加载体积。
12. logger-hardening：完善 `logger.js` 的环形缓冲实现，支持按范围导出与可配置条目上限。
13. ui-tweaks：发送/停止互斥、联网内联开关、更明确的加载/流式指示（spinner/progress）。
14. docs-sync：同步并更新 `README.md`、`README_zh.md`、`CURSOR.md` 的变更记录与使用说明。

关键代码片段示例（用于实现第2项：AbortController，示例仅为建议）：

```javascript
// 在 sendMessage 或 fetchDeepSeekResponseStream 中
const controller = new AbortController();
window._currentRequestController = controller; // 供停止按钮访问
fetch(endpoint, { method: 'POST', body, signal: controller.signal })
  .then(res => { /* 处理流式 */ })
  .catch(err => {
    if (err.name === 'AbortError') {
      // 友好反馈：已取消
    } else {
      // 正常错误处理与重试
    }
  });
// 停止按钮动作
function stopGeneration() {
  if (window._currentRequestController) {
    window._currentRequestController.abort();
    window._currentRequestController = null;
  }
}
```

验收标准（高层）：

- 用户点击“停止”可即时中止正在进行的生成，并停止流式更新。
- 高频会话不会因每次流式更新频繁写入 `localStorage` 导致 UI 卡顿或 I/O 激增。
- 联网检索结果的引用在助手消息下方正确显示并可点击至来源域名。
- 会话记忆生成较之前更少噪声、符合 CURSOR.md 中“必须保留/严禁包含”规则。
- 首屏加载体积显著下降（通过懒加载），感知延迟改善。

安全与风险说明：

- 所有改动均为前端改造，API Key 不应放在前端。建议配合后端代理以提高安全性与绕过 CORS。该计划不在未经你同意下更改 Key 存储位置。

下一步：

- 请确认此计划（批准后我将生成逐项实现细节的代码变更清单与 PR 草案）。